import"./modulepreload-polyfill-3cfb730f.js";import{S as Ze,T as je,h as Ke,a as Ne,s as Je,q as Ie,A as $e,D as to,P as eo,W as oo,y as io,E as ro,w as no,g as ao}from"./three.module-13a89988.js";import{O as so}from"./OrbitControls-63ae8fc2.js";import{G as lo}from"./lil-gui.esm-1e0f7d72.js";function ze(It){throw new Error('Could not dynamically require "'+It+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Fe={},ho={get exports(){return Fe},set exports(It){Fe=It}};(function(It,re){(function(v){It.exports=v()})(function(){return function v(N,at,p){function e(l,o){if(!at[l]){if(!N[l]){var t=typeof ze=="function"&&ze;if(!o&&t)return t(l,!0);if(s)return s(l,!0);throw new Error("Cannot find module '"+l+"'")}var i=at[l]={exports:{}};N[l][0].call(i.exports,function(n){var a=N[l][1][n];return e(a||n)},i,i.exports,v,N,at,p)}return at[l].exports}for(var s=typeof ze=="function"&&ze,r=0;r<p.length;r++)e(p[r]);return e}({1:[function(v,N,at){N.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(v,N,at){N.exports={version:v("../package.json").version,AABB:v("./collision/AABB"),ArrayCollisionMatrix:v("./collision/ArrayCollisionMatrix"),Body:v("./objects/Body"),Box:v("./shapes/Box"),Broadphase:v("./collision/Broadphase"),Constraint:v("./constraints/Constraint"),ContactEquation:v("./equations/ContactEquation"),Narrowphase:v("./world/Narrowphase"),ConeTwistConstraint:v("./constraints/ConeTwistConstraint"),ContactMaterial:v("./material/ContactMaterial"),ConvexPolyhedron:v("./shapes/ConvexPolyhedron"),Cylinder:v("./shapes/Cylinder"),DistanceConstraint:v("./constraints/DistanceConstraint"),Equation:v("./equations/Equation"),EventTarget:v("./utils/EventTarget"),FrictionEquation:v("./equations/FrictionEquation"),GSSolver:v("./solver/GSSolver"),GridBroadphase:v("./collision/GridBroadphase"),Heightfield:v("./shapes/Heightfield"),HingeConstraint:v("./constraints/HingeConstraint"),LockConstraint:v("./constraints/LockConstraint"),Mat3:v("./math/Mat3"),Material:v("./material/Material"),NaiveBroadphase:v("./collision/NaiveBroadphase"),ObjectCollisionMatrix:v("./collision/ObjectCollisionMatrix"),Pool:v("./utils/Pool"),Particle:v("./shapes/Particle"),Plane:v("./shapes/Plane"),PointToPointConstraint:v("./constraints/PointToPointConstraint"),Quaternion:v("./math/Quaternion"),Ray:v("./collision/Ray"),RaycastVehicle:v("./objects/RaycastVehicle"),RaycastResult:v("./collision/RaycastResult"),RigidVehicle:v("./objects/RigidVehicle"),RotationalEquation:v("./equations/RotationalEquation"),RotationalMotorEquation:v("./equations/RotationalMotorEquation"),SAPBroadphase:v("./collision/SAPBroadphase"),SPHSystem:v("./objects/SPHSystem"),Shape:v("./shapes/Shape"),Solver:v("./solver/Solver"),Sphere:v("./shapes/Sphere"),SplitSolver:v("./solver/SplitSolver"),Spring:v("./objects/Spring"),Trimesh:v("./shapes/Trimesh"),Vec3:v("./math/Vec3"),Vec3Pool:v("./utils/Vec3Pool"),World:v("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(v,N,at){var p=v("../math/Vec3");v("../utils/Utils"),N.exports=e;function e(l){l=l||{},this.lowerBound=new p,l.lowerBound&&this.lowerBound.copy(l.lowerBound),this.upperBound=new p,l.upperBound&&this.upperBound.copy(l.upperBound)}var s=new p;e.prototype.setFromPoints=function(l,o,t,i){var n=this.lowerBound,a=this.upperBound,c=t;n.copy(l[0]),c&&c.vmult(n,n),a.copy(n);for(var h=1;h<l.length;h++){var u=l[h];c&&(c.vmult(u,s),u=s),u.x>a.x&&(a.x=u.x),u.x<n.x&&(n.x=u.x),u.y>a.y&&(a.y=u.y),u.y<n.y&&(n.y=u.y),u.z>a.z&&(a.z=u.z),u.z<n.z&&(n.z=u.z)}return o&&(o.vadd(n,n),o.vadd(a,a)),i&&(n.x-=i,n.y-=i,n.z-=i,a.x+=i,a.y+=i,a.z+=i),this},e.prototype.copy=function(l){return this.lowerBound.copy(l.lowerBound),this.upperBound.copy(l.upperBound),this},e.prototype.clone=function(){return new e().copy(this)},e.prototype.extend=function(l){var o=l.lowerBound.x;this.lowerBound.x>o&&(this.lowerBound.x=o);var t=l.upperBound.x;this.upperBound.x<t&&(this.upperBound.x=t);var o=l.lowerBound.y;this.lowerBound.y>o&&(this.lowerBound.y=o);var t=l.upperBound.y;this.upperBound.y<t&&(this.upperBound.y=t);var o=l.lowerBound.z;this.lowerBound.z>o&&(this.lowerBound.z=o);var t=l.upperBound.z;this.upperBound.z<t&&(this.upperBound.z=t)},e.prototype.overlaps=function(l){var o=this.lowerBound,t=this.upperBound,i=l.lowerBound,n=l.upperBound;return(i.x<=t.x&&t.x<=n.x||o.x<=n.x&&n.x<=t.x)&&(i.y<=t.y&&t.y<=n.y||o.y<=n.y&&n.y<=t.y)&&(i.z<=t.z&&t.z<=n.z||o.z<=n.z&&n.z<=t.z)},e.prototype.contains=function(l){var o=this.lowerBound,t=this.upperBound,i=l.lowerBound,n=l.upperBound;return o.x<=i.x&&t.x>=n.x&&o.y<=i.y&&t.y>=n.y&&o.z<=i.z&&t.z>=n.z},e.prototype.getCorners=function(l,o,t,i,n,a,c,h){var u=this.lowerBound,d=this.upperBound;l.copy(u),o.set(d.x,u.y,u.z),t.set(d.x,d.y,u.z),i.set(u.x,d.y,d.z),n.set(d.x,u.y,u.z),a.set(u.x,d.y,u.z),c.set(u.x,u.y,d.z),h.copy(d)};var r=[new p,new p,new p,new p,new p,new p,new p,new p];e.prototype.toLocalFrame=function(l,o){var t=r,i=t[0],n=t[1],a=t[2],c=t[3],h=t[4],u=t[5],d=t[6],x=t[7];this.getCorners(i,n,a,c,h,u,d,x);for(var f=0;f!==8;f++){var b=t[f];l.pointToLocal(b,b)}return o.setFromPoints(t)},e.prototype.toWorldFrame=function(l,o){var t=r,i=t[0],n=t[1],a=t[2],c=t[3],h=t[4],u=t[5],d=t[6],x=t[7];this.getCorners(i,n,a,c,h,u,d,x);for(var f=0;f!==8;f++){var b=t[f];l.pointToWorld(b,b)}return o.setFromPoints(t)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(v,N,at){N.exports=p;function p(){this.matrix=[]}p.prototype.get=function(e,s){if(e=e.index,s=s.index,s>e){var r=s;s=e,e=r}return this.matrix[(e*(e+1)>>1)+s-1]},p.prototype.set=function(e,s,r){if(e=e.index,s=s.index,s>e){var l=s;s=e,e=l}this.matrix[(e*(e+1)>>1)+s-1]=r?1:0},p.prototype.reset=function(){for(var e=0,s=this.matrix.length;e!==s;e++)this.matrix[e]=0},p.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(v,N,at){var p=v("../objects/Body"),e=v("../math/Vec3"),s=v("../math/Quaternion");v("../shapes/Shape"),v("../shapes/Plane"),N.exports=r;function r(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}r.prototype.collisionPairs=function(c,h,u){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var l=p.STATIC|p.KINEMATIC;r.prototype.needBroadphaseCollision=function(c,h){return!(!(c.collisionFilterGroup&h.collisionFilterMask)||!(h.collisionFilterGroup&c.collisionFilterMask)||(c.type&l||c.sleepState===p.SLEEPING)&&(h.type&l||h.sleepState===p.SLEEPING))},r.prototype.intersectionTest=function(c,h,u,d){this.useBoundingBoxes?this.doBoundingBoxBroadphase(c,h,u,d):this.doBoundingSphereBroadphase(c,h,u,d)};var o=new e;new e,new s,new e,r.prototype.doBoundingSphereBroadphase=function(c,h,u,d){var x=o;h.position.vsub(c.position,x);var f=Math.pow(c.boundingRadius+h.boundingRadius,2),b=x.norm2();b<f&&(u.push(c),d.push(h))},r.prototype.doBoundingBoxBroadphase=function(c,h,u,d){c.aabbNeedsUpdate&&c.computeAABB(),h.aabbNeedsUpdate&&h.computeAABB(),c.aabb.overlaps(h.aabb)&&(u.push(c),d.push(h))};var t={keys:[]},i=[],n=[];r.prototype.makePairsUnique=function(c,h){for(var u=t,d=i,x=n,f=c.length,b=0;b!==f;b++)d[b]=c[b],x[b]=h[b];c.length=0,h.length=0;for(var b=0;b!==f;b++){var H=d[b].id,st=x[b].id,V=H<st?H+","+st:st+","+H;u[V]=b,u.keys.push(V)}for(var b=0;b!==u.keys.length;b++){var V=u.keys.pop(),k=u[V];c.push(d[k]),h.push(x[k]),delete u[V]}},r.prototype.setWorld=function(c){};var a=new e;r.boundingSphereCheck=function(c,h){var u=a;return c.position.vsub(h.position,u),Math.pow(c.shape.boundingSphereRadius+h.shape.boundingSphereRadius,2)>u.norm2()},r.prototype.aabbQuery=function(c,h,u){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(v,N,at){N.exports=r;var p=v("./Broadphase"),e=v("../math/Vec3"),s=v("../shapes/Shape");function r(o,t,i,n,a){p.apply(this),this.nx=i||10,this.ny=n||10,this.nz=a||10,this.aabbMin=o||new e(100,100,100),this.aabbMax=t||new e(-100,-100,-100);var c=this.nx*this.ny*this.nz;if(c<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=c,this.binLengths.length=c;for(var h=0;h<c;h++)this.bins[h]=[],this.binLengths[h]=0}r.prototype=new p,r.prototype.constructor=r;var l=new e;new e,r.prototype.collisionPairs=function(o,t,i){var n=o.numObjects(),a=o.bodies,G=this.aabbMax,C=this.aabbMin,c=this.nx,h=this.ny,u=this.nz,d=h*u,x=u,f=1,b=G.x,H=G.y,st=G.z,V=C.x,k=C.y,M=C.z,B=c/(b-V),F=h/(H-k),T=u/(st-M),K=(b-V)/c,j=(H-k)/h,pt=(st-M)/u,z=Math.sqrt(K*K+j*j+pt*pt)*.5,A=s.types,_=A.SPHERE,q=A.PLANE;A.BOX,A.COMPOUND,A.CONVEXPOLYHEDRON;for(var g=this.bins,R=this.binLengths,w=this.bins.length,m=0;m!==w;m++)R[m]=0;var y=Math.ceil,C=Math.min,G=Math.max;function W(le,fe,he,Zt,jt,we,ye){var ne=(le-V)*B|0,ee=(fe-k)*F|0,_t=(he-M)*T|0,ae=y((Zt-V)*B),oe=y((jt-k)*F),Ht=y((we-M)*T);ne<0?ne=0:ne>=c&&(ne=c-1),ee<0?ee=0:ee>=h&&(ee=h-1),_t<0?_t=0:_t>=u&&(_t=u-1),ae<0?ae=0:ae>=c&&(ae=c-1),oe<0?oe=0:oe>=h&&(oe=h-1),Ht<0?Ht=0:Ht>=u&&(Ht=u-1),ne*=d,ee*=x,_t*=f,ae*=d,oe*=x,Ht*=f;for(var xe=ne;xe<=ae;xe+=d)for(var ge=ee;ge<=oe;ge+=x)for(var Be=_t;Be<=Ht;Be+=f){var Ce=xe+ge+Be;g[Ce][R[Ce]++]=ye}}for(var m=0;m!==n;m++){var E=a[m],L=E.shape;switch(L.type){case _:var X=E.position.x,ut=E.position.y,lt=E.position.z,nt=L.radius;W(X-nt,ut-nt,lt-nt,X+nt,ut+nt,lt+nt,E);break;case q:L.worldNormalNeedsUpdate&&L.computeWorldNormal(E.quaternion);var O=L.worldNormal,Q=V+K*.5-E.position.x,bt=k+j*.5-E.position.y,ft=M+pt*.5-E.position.z,zt=l;zt.set(Q,bt,ft);for(var ct=0,St=0;ct!==c;ct++,St+=d,zt.y=bt,zt.x+=K)for(var Rt=0,Mt=0;Rt!==h;Rt++,Mt+=x,zt.z=ft,zt.y+=j)for(var Vt=0,At=0;Vt!==u;Vt++,At+=f,zt.z+=pt)if(zt.dot(O)<z){var Tt=St+Mt+At;g[Tt][R[Tt]++]=E}break;default:E.aabbNeedsUpdate&&E.computeAABB(),W(E.aabb.lowerBound.x,E.aabb.lowerBound.y,E.aabb.lowerBound.z,E.aabb.upperBound.x,E.aabb.upperBound.y,E.aabb.upperBound.z,E);break}}for(var m=0;m!==w;m++){var Et=R[m];if(Et>1)for(var Lt=g[m],ct=0;ct!==Et;ct++)for(var E=Lt[ct],Rt=0;Rt!==ct;Rt++){var Ut=Lt[Rt];this.needBroadphaseCollision(E,Ut)&&this.intersectionTest(E,Ut,t,i)}}this.makePairsUnique(t,i)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(v,N,at){N.exports=s;var p=v("./Broadphase"),e=v("./AABB");function s(){p.apply(this)}s.prototype=new p,s.prototype.constructor=s,s.prototype.collisionPairs=function(r,l,o){var t=r.bodies,i=t.length,n,a,c,h;for(n=0;n!==i;n++)for(a=0;a!==n;a++)c=t[n],h=t[a],this.needBroadphaseCollision(c,h)&&this.intersectionTest(c,h,l,o)},new e,s.prototype.aabbQuery=function(r,l,o){o=o||[];for(var t=0;t<r.bodies.length;t++){var i=r.bodies[t];i.aabbNeedsUpdate&&i.computeAABB(),i.aabb.overlaps(l)&&o.push(i)}return o}},{"./AABB":3,"./Broadphase":5}],8:[function(v,N,at){N.exports=p;function p(){this.matrix={}}p.prototype.get=function(e,s){if(e=e.id,s=s.id,s>e){var r=s;s=e,e=r}return e+"-"+s in this.matrix},p.prototype.set=function(e,s,r){if(e=e.id,s=s.id,s>e){var l=s;s=e,e=l}r?this.matrix[e+"-"+s]=!0:delete this.matrix[e+"-"+s]},p.prototype.reset=function(){this.matrix={}},p.prototype.setNumObjects=function(e){}},{}],9:[function(v,N,at){N.exports=t;var p=v("../math/Vec3"),e=v("../math/Quaternion"),s=v("../math/Transform");v("../shapes/ConvexPolyhedron"),v("../shapes/Box");var r=v("../collision/RaycastResult"),l=v("../shapes/Shape"),o=v("../collision/AABB");function t(w,m){this.from=w?w.clone():new p,this.to=m?m.clone():new p,this._direction=new p,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=t.ANY,this.result=new r,this.hasHit=!1,this.callback=function(y){}}t.prototype.constructor=t,t.CLOSEST=1,t.ANY=2,t.ALL=4;var i=new o,n=[];t.prototype.intersectWorld=function(w,m){return this.mode=m.mode||t.ANY,this.result=m.result||new r,this.skipBackfaces=!!m.skipBackfaces,this.collisionFilterMask=typeof m.collisionFilterMask<"u"?m.collisionFilterMask:-1,this.collisionFilterGroup=typeof m.collisionFilterGroup<"u"?m.collisionFilterGroup:-1,m.from&&this.from.copy(m.from),m.to&&this.to.copy(m.to),this.callback=m.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(i),n.length=0,w.broadphase.aabbQuery(w,i,n),this.intersectBodies(n),this.hasHit};var a=new p,c=new p;t.pointInTriangle=h;function h(w,m,y,C){C.vsub(m,q),y.vsub(m,a),w.vsub(m,c);var G=q.dot(q),W=q.dot(a),E=q.dot(c),L=a.dot(a),X=a.dot(c),ut,lt;return(ut=L*E-W*X)>=0&&(lt=G*X-W*E)>=0&&ut+lt<G*L-W*W}var u=new p,d=new e;t.prototype.intersectBody=function(w,m){m&&(this.result=m,this._updateDirection());var y=this.checkCollisionResponse;if(!(y&&!w.collisionResponse)&&!(!(this.collisionFilterGroup&w.collisionFilterMask)||!(w.collisionFilterGroup&this.collisionFilterMask)))for(var C=u,G=d,W=0,E=w.shapes.length;W<E;W++){var L=w.shapes[W];if(!(y&&!L.collisionResponse)&&(w.quaternion.mult(w.shapeOrientations[W],G),w.quaternion.vmult(w.shapeOffsets[W],C),C.vadd(w.position,C),this.intersectShape(L,G,C,w),this.result._shouldStop))break}},t.prototype.intersectBodies=function(w,m){m&&(this.result=m,this._updateDirection());for(var y=0,C=w.length;!this.result._shouldStop&&y<C;y++)this.intersectBody(w[y])},t.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},t.prototype.intersectShape=function(w,m,y,C){var G=this.from,W=R(G,this._direction,y);if(!(W>w.boundingSphereRadius)){var E=this[w.type];E&&E.call(this,w,m,y,C)}},new p,new p;var x=new p,f=new p,b=new p,H=new p;new p,new r,t.prototype.intersectBox=function(w,m,y,C){return this.intersectConvex(w.convexPolyhedronRepresentation,m,y,C)},t.prototype[l.types.BOX]=t.prototype.intersectBox,t.prototype.intersectPlane=function(w,m,y,C){var G=this.from,W=this.to,E=this._direction,L=new p(0,0,1);m.vmult(L,L);var X=new p;G.vsub(y,X);var ut=X.dot(L);W.vsub(y,X);var lt=X.dot(L);if(!(ut*lt>0)&&!(G.distanceTo(W)<ut)){var nt=L.dot(E);if(!(Math.abs(nt)<this.precision)){var O=new p,Q=new p,bt=new p;G.vsub(y,O);var ft=-L.dot(O)/nt;E.scale(ft,Q),G.vadd(Q,bt),this.reportIntersection(L,bt,w,C,-1)}}},t.prototype[l.types.PLANE]=t.prototype.intersectPlane,t.prototype.getAABB=function(w){var m=this.to,y=this.from;w.lowerBound.x=Math.min(m.x,y.x),w.lowerBound.y=Math.min(m.y,y.y),w.lowerBound.z=Math.min(m.z,y.z),w.upperBound.x=Math.max(m.x,y.x),w.upperBound.y=Math.max(m.y,y.y),w.upperBound.z=Math.max(m.z,y.z)};var st={faceList:[0]};t.prototype.intersectHeightfield=function(w,m,y,C){w.data,w.elementSize;var G=new p,W=new t(this.from,this.to);s.pointToLocalFrame(y,m,W.from,W.from),s.pointToLocalFrame(y,m,W.to,W.to);var E=[],L=null,X=null,ut=null,lt=null,nt=w.getIndexOfPosition(W.from.x,W.from.y,E,!1);if(nt&&(L=E[0],X=E[1],ut=E[0],lt=E[1]),nt=w.getIndexOfPosition(W.to.x,W.to.y,E,!1),nt&&((L===null||E[0]<L)&&(L=E[0]),(ut===null||E[0]>ut)&&(ut=E[0]),(X===null||E[1]<X)&&(X=E[1]),(lt===null||E[1]>lt)&&(lt=E[1])),L!==null){var O=[];w.getRectMinMax(L,X,ut,lt,O);for(var Q=L;Q<=ut;Q++)for(var bt=X;bt<=lt;bt++){if(this.result._shouldStop||(w.getConvexTrianglePillar(Q,bt,!1),s.pointToWorldFrame(y,m,w.pillarOffset,G),this.intersectConvex(w.pillarConvex,m,G,C,st),this.result._shouldStop))return;w.getConvexTrianglePillar(Q,bt,!0),s.pointToWorldFrame(y,m,w.pillarOffset,G),this.intersectConvex(w.pillarConvex,m,G,C,st)}}},t.prototype[l.types.HEIGHTFIELD]=t.prototype.intersectHeightfield;var V=new p,k=new p;t.prototype.intersectSphere=function(w,m,y,C){var G=this.from,W=this.to,E=w.radius,L=Math.pow(W.x-G.x,2)+Math.pow(W.y-G.y,2)+Math.pow(W.z-G.z,2),X=2*((W.x-G.x)*(G.x-y.x)+(W.y-G.y)*(G.y-y.y)+(W.z-G.z)*(G.z-y.z)),ut=Math.pow(G.x-y.x,2)+Math.pow(G.y-y.y,2)+Math.pow(G.z-y.z,2)-Math.pow(E,2),lt=Math.pow(X,2)-4*L*ut,nt=V,O=k;if(!(lt<0))if(lt===0)G.lerp(W,lt,nt),nt.vsub(y,O),O.normalize(),this.reportIntersection(O,nt,w,C,-1);else{var Q=(-X-Math.sqrt(lt))/(2*L),bt=(-X+Math.sqrt(lt))/(2*L);if(Q>=0&&Q<=1&&(G.lerp(W,Q,nt),nt.vsub(y,O),O.normalize(),this.reportIntersection(O,nt,w,C,-1)),this.result._shouldStop)return;bt>=0&&bt<=1&&(G.lerp(W,bt,nt),nt.vsub(y,O),O.normalize(),this.reportIntersection(O,nt,w,C,-1))}},t.prototype[l.types.SPHERE]=t.prototype.intersectSphere;var M=new p;new p,new p;var B=new p;t.prototype.intersectConvex=function(m,y,C,G,W){for(var E=M,L=B,X=W&&W.faceList||null,ut=m.faces,lt=m.vertices,nt=m.faceNormals,O=this._direction,Q=this.from,bt=this.to,ft=Q.distanceTo(bt),zt=X?X.length:ut.length,ct=this.result,St=0;!ct._shouldStop&&St<zt;St++){var Rt=X?X[St]:St,Mt=ut[Rt],Vt=nt[Rt],At=y,Tt=C;L.copy(lt[Mt[0]]),At.vmult(L,L),L.vadd(Tt,L),L.vsub(Q,L),At.vmult(Vt,E);var Et=O.dot(E);if(!(Math.abs(Et)<this.precision)){var Lt=E.dot(L)/Et;if(!(Lt<0)){O.mult(Lt,x),x.vadd(Q,x),f.copy(lt[Mt[0]]),At.vmult(f,f),Tt.vadd(f,f);for(var Ut=1;!ct._shouldStop&&Ut<Mt.length-1;Ut++){b.copy(lt[Mt[Ut]]),H.copy(lt[Mt[Ut+1]]),At.vmult(b,b),At.vmult(H,H),Tt.vadd(b,b),Tt.vadd(H,H);var le=x.distanceTo(Q);!(h(x,f,b,H)||h(x,b,f,H))||le>ft||this.reportIntersection(E,x,m,G,Rt)}}}}},t.prototype[l.types.CONVEXPOLYHEDRON]=t.prototype.intersectConvex;var F=new p,T=new p,K=new p,j=new p,pt=new p,z=new p;new o;var A=[],_=new s;t.prototype.intersectTrimesh=function(m,y,C,G,W){var E=F,L=A,X=_,ut=B,lt=T,nt=K,O=j,Q=z,bt=pt;W&&W.faceList;var ft=m.indices;m.vertices,m.faceNormals;var zt=this.from,ct=this.to,St=this._direction;X.position.copy(C),X.quaternion.copy(y),s.vectorToLocalFrame(C,y,St,lt),s.pointToLocalFrame(C,y,zt,nt),s.pointToLocalFrame(C,y,ct,O);var Rt=nt.distanceSquared(O);m.tree.rayQuery(this,X,L);for(var Mt=0,Vt=L.length;!this.result._shouldStop&&Mt!==Vt;Mt++){var At=L[Mt];m.getNormal(At,E),m.getVertex(ft[At*3],f),f.vsub(nt,ut);var Tt=lt.dot(E),Et=E.dot(ut)/Tt;if(!(Et<0)){lt.scale(Et,x),x.vadd(nt,x),m.getVertex(ft[At*3+1],b),m.getVertex(ft[At*3+2],H);var Lt=x.distanceSquared(nt);!(h(x,b,f,H)||h(x,f,b,H))||Lt>Rt||(s.vectorToWorldFrame(y,E,bt),s.pointToWorldFrame(C,y,x,Q),this.reportIntersection(bt,Q,m,G,At))}}L.length=0},t.prototype[l.types.TRIMESH]=t.prototype.intersectTrimesh,t.prototype.reportIntersection=function(w,m,y,C,G){var W=this.from,E=this.to,L=W.distanceTo(m),X=this.result;if(!(this.skipBackfaces&&w.dot(this._direction)>0))switch(X.hitFaceIndex=typeof G<"u"?G:-1,this.mode){case t.ALL:this.hasHit=!0,X.set(W,E,w,m,y,C,L),X.hasHit=!0,this.callback(X);break;case t.CLOSEST:(L<X.distance||!X.hasHit)&&(this.hasHit=!0,X.hasHit=!0,X.set(W,E,w,m,y,C,L));break;case t.ANY:this.hasHit=!0,X.hasHit=!0,X.set(W,E,w,m,y,C,L),X._shouldStop=!0;break}};var q=new p,g=new p;function R(w,m,y){y.vsub(w,q);var C=q.dot(m);m.mult(C,g),g.vadd(w,g);var G=y.distanceTo(g);return G}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(v,N,at){var p=v("../math/Vec3");N.exports=e;function e(){this.rayFromWorld=new p,this.rayToWorld=new p,this.hitNormalWorld=new p,this.hitPointWorld=new p,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}e.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},e.prototype.abort=function(){this._shouldStop=!0},e.prototype.set=function(s,r,l,o,t,i,n){this.rayFromWorld.copy(s),this.rayToWorld.copy(r),this.hitNormalWorld.copy(l),this.hitPointWorld.copy(o),this.shape=t,this.body=i,this.distance=n}},{"../math/Vec3":30}],11:[function(v,N,at){v("../shapes/Shape");var p=v("../collision/Broadphase");N.exports=e;function e(s){p.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var r=this.axisList;this._addBodyHandler=function(l){r.push(l.body)},this._removeBodyHandler=function(l){var o=r.indexOf(l.body);o!==-1&&r.splice(o,1)},s&&this.setWorld(s)}e.prototype=new p,e.prototype.setWorld=function(s){this.axisList.length=0;for(var r=0;r<s.bodies.length;r++)this.axisList.push(s.bodies[r]);s.removeEventListener("addBody",this._addBodyHandler),s.removeEventListener("removeBody",this._removeBodyHandler),s.addEventListener("addBody",this._addBodyHandler),s.addEventListener("removeBody",this._removeBodyHandler),this.world=s,this.dirty=!0},e.insertionSortX=function(s){for(var r=1,l=s.length;r<l;r++){for(var o=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.x<=o.aabb.lowerBound.x);t--)s[t+1]=s[t];s[t+1]=o}return s},e.insertionSortY=function(s){for(var r=1,l=s.length;r<l;r++){for(var o=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.y<=o.aabb.lowerBound.y);t--)s[t+1]=s[t];s[t+1]=o}return s},e.insertionSortZ=function(s){for(var r=1,l=s.length;r<l;r++){for(var o=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.z<=o.aabb.lowerBound.z);t--)s[t+1]=s[t];s[t+1]=o}return s},e.prototype.collisionPairs=function(s,r,l){var o=this.axisList,t=o.length,i=this.axisIndex,n,a;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==t;n++){var c=o[n];for(a=n+1;a<t;a++){var h=o[a];if(this.needBroadphaseCollision(c,h)){if(!e.checkBounds(c,h,i))break;this.intersectionTest(c,h,r,l)}}}},e.prototype.sortList=function(){for(var s=this.axisList,r=this.axisIndex,l=s.length,o=0;o!==l;o++){var t=s[o];t.aabbNeedsUpdate&&t.computeAABB()}r===0?e.insertionSortX(s):r===1?e.insertionSortY(s):r===2&&e.insertionSortZ(s)},e.checkBounds=function(s,r,l){var o,t;l===0?(o=s.position.x,t=r.position.x):l===1?(o=s.position.y,t=r.position.y):l===2&&(o=s.position.z,t=r.position.z);var i=s.boundingRadius,n=r.boundingRadius,a=o+i,c=t-n;return c<a},e.prototype.autoDetectAxis=function(){for(var s=0,r=0,l=0,o=0,t=0,i=0,n=this.axisList,a=n.length,c=1/a,h=0;h!==a;h++){var u=n[h],d=u.position.x;s+=d,r+=d*d;var x=u.position.y;l+=x,o+=x*x;var f=u.position.z;t+=f,i+=f*f}var b=r-s*s*c,H=o-l*l*c,st=i-t*t*c;b>H?b>st?this.axisIndex=0:this.axisIndex=2:H>st?this.axisIndex=1:this.axisIndex=2},e.prototype.aabbQuery=function(s,r,l){l=l||[],this.dirty&&(this.sortList(),this.dirty=!1);var o=this.axisIndex,t="x";o===1&&(t="y"),o===2&&(t="z");var i=this.axisList;r.lowerBound[t],r.upperBound[t];for(var n=0;n<i.length;n++){var a=i[n];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(r)&&l.push(a)}return l}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(v,N,at){N.exports=l,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/ConeEquation"),s=v("../equations/RotationalEquation");v("../equations/ContactEquation");var r=v("../math/Vec3");function l(o,t,i){i=i||{};var n=typeof i.maxForce<"u"?i.maxForce:1e6,a=i.pivotA?i.pivotA.clone():new r,c=i.pivotB?i.pivotB.clone():new r;this.axisA=i.axisA?i.axisA.clone():new r,this.axisB=i.axisB?i.axisB.clone():new r,p.call(this,o,a,t,c,n),this.collideConnected=!!i.collideConnected,this.angle=typeof i.angle<"u"?i.angle:0;var h=this.coneEquation=new e(o,t,i),u=this.twistEquation=new s(o,t,i);this.twistAngle=typeof i.twistAngle<"u"?i.twistAngle:0,h.maxForce=0,h.minForce=-n,u.maxForce=0,u.minForce=-n,this.equations.push(h,u)}l.prototype=new p,l.constructor=l,new r,new r,l.prototype.update=function(){var o=this.bodyA,t=this.bodyB,i=this.coneEquation,n=this.twistEquation;p.prototype.update.call(this),o.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(n.axisA,n.axisA),o.vectorToWorldFrame(n.axisA,n.axisA),this.axisB.tangents(n.axisB,n.axisB),t.vectorToWorldFrame(n.axisB,n.axisB),i.angle=this.angle,n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(v,N,at){N.exports=e;var p=v("../utils/Utils");function e(s,r,l){l=p.defaults(l,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=s,this.bodyB=r,this.id=e.idCounter++,this.collideConnected=l.collideConnected,l.wakeUpBodies&&(s&&s.wakeUp(),r&&r.wakeUp())}e.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},e.prototype.enable=function(){for(var s=this.equations,r=0;r<s.length;r++)s[r].enabled=!0},e.prototype.disable=function(){for(var s=this.equations,r=0;r<s.length;r++)s[r].enabled=!1},e.idCounter=0},{"../utils/Utils":53}],14:[function(v,N,at){N.exports=s;var p=v("./Constraint"),e=v("../equations/ContactEquation");function s(r,l,o,t){p.call(this,r,l),typeof o>"u"&&(o=r.position.distanceTo(l.position)),typeof t>"u"&&(t=1e6),this.distance=o;var i=this.distanceEquation=new e(r,l);this.equations.push(i),i.minForce=-t,i.maxForce=t}s.prototype=new p,s.prototype.update=function(){var r=this.bodyA,l=this.bodyB,o=this.distanceEquation,t=this.distance*.5,i=o.ni;l.position.vsub(r.position,i),i.normalize(),i.mult(t,o.ri),i.mult(-t,o.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(v,N,at){N.exports=l,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/RotationalEquation"),s=v("../equations/RotationalMotorEquation");v("../equations/ContactEquation");var r=v("../math/Vec3");function l(i,n,a){a=a||{};var c=typeof a.maxForce<"u"?a.maxForce:1e6,h=a.pivotA?a.pivotA.clone():new r,u=a.pivotB?a.pivotB.clone():new r;p.call(this,i,h,n,u,c);var d=this.axisA=a.axisA?a.axisA.clone():new r(1,0,0);d.normalize();var x=this.axisB=a.axisB?a.axisB.clone():new r(1,0,0);x.normalize();var f=this.rotationalEquation1=new e(i,n,a),b=this.rotationalEquation2=new e(i,n,a),H=this.motorEquation=new s(i,n,c);H.enabled=!1,this.equations.push(f,b,H)}l.prototype=new p,l.constructor=l,l.prototype.enableMotor=function(){this.motorEquation.enabled=!0},l.prototype.disableMotor=function(){this.motorEquation.enabled=!1},l.prototype.setMotorSpeed=function(i){this.motorEquation.targetVelocity=i},l.prototype.setMotorMaxForce=function(i){this.motorEquation.maxForce=i,this.motorEquation.minForce=-i};var o=new r,t=new r;l.prototype.update=function(){var i=this.bodyA,n=this.bodyB,a=this.motorEquation,c=this.rotationalEquation1,h=this.rotationalEquation2,u=o,d=t,x=this.axisA,f=this.axisB;p.prototype.update.call(this),i.quaternion.vmult(x,u),n.quaternion.vmult(f,d),u.tangents(c.axisA,h.axisA),c.axisB.copy(d),h.axisB.copy(d),this.motorEquation.enabled&&(i.quaternion.vmult(this.axisA,a.axisA),n.quaternion.vmult(this.axisB,a.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(v,N,at){N.exports=r,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/RotationalEquation");v("../equations/RotationalMotorEquation"),v("../equations/ContactEquation");var s=v("../math/Vec3");function r(l,o,t){t=t||{};var i=typeof t.maxForce<"u"?t.maxForce:1e6,n=new s,a=new s,c=new s;l.position.vadd(o.position,c),c.scale(.5,c),o.pointToLocalFrame(c,a),l.pointToLocalFrame(c,n),p.call(this,l,n,o,a,i);var h=this.rotationalEquation1=new e(l,o,t),u=this.rotationalEquation2=new e(l,o,t),d=this.rotationalEquation3=new e(l,o,t);this.equations.push(h,u,d)}r.prototype=new p,r.constructor=r,new s,new s,r.prototype.update=function(){var l=this.bodyA,o=this.bodyB;this.motorEquation;var t=this.rotationalEquation1,i=this.rotationalEquation2,n=this.rotationalEquation3;p.prototype.update.call(this),l.vectorToWorldFrame(s.UNIT_X,t.axisA),o.vectorToWorldFrame(s.UNIT_Y,t.axisB),l.vectorToWorldFrame(s.UNIT_Y,i.axisA),o.vectorToWorldFrame(s.UNIT_Z,i.axisB),l.vectorToWorldFrame(s.UNIT_Z,n.axisA),o.vectorToWorldFrame(s.UNIT_X,n.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(v,N,at){N.exports=r;var p=v("./Constraint"),e=v("../equations/ContactEquation"),s=v("../math/Vec3");function r(l,o,t,i,n){p.call(this,l,t),n=typeof n<"u"?n:1e6,this.pivotA=o?o.clone():new s,this.pivotB=i?i.clone():new s;var a=this.equationX=new e(l,t),c=this.equationY=new e(l,t),h=this.equationZ=new e(l,t);this.equations.push(a,c,h),a.minForce=c.minForce=h.minForce=-n,a.maxForce=c.maxForce=h.maxForce=n,a.ni.set(1,0,0),c.ni.set(0,1,0),h.ni.set(0,0,1)}r.prototype=new p,r.prototype.update=function(){var l=this.bodyA,o=this.bodyB,t=this.equationX,i=this.equationY,n=this.equationZ;l.quaternion.vmult(this.pivotA,t.ri),o.quaternion.vmult(this.pivotB,t.rj),i.ri.copy(t.ri),i.rj.copy(t.rj),n.ri.copy(t.ri),n.rj.copy(t.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(v,N,at){N.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(o,t,i){i=i||{};var n=typeof i.maxForce<"u"?i.maxForce:1e6;e.call(this,o,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new p(1,0,0),this.axisB=i.axisB?i.axisB.clone():new p(0,1,0),this.angle=typeof i.angle<"u"?i.angle:0}s.prototype=new e,s.prototype.constructor=s;var r=new p,l=new p;s.prototype.computeB=function(o){var t=this.a,i=this.b,n=this.axisA,a=this.axisB,c=r,h=l,u=this.jacobianElementA,d=this.jacobianElementB;n.cross(a,c),a.cross(n,h),u.rotational.copy(h),d.rotational.copy(c);var x=Math.cos(this.angle)-n.dot(a),f=this.computeGW(),b=this.computeGiMf(),H=-x*t-f*i-o*b;return H}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(v,N,at){N.exports=s;var p=v("./Equation"),e=v("../math/Vec3");v("../math/Mat3");function s(h,u,d){d=typeof d<"u"?d:1e6,p.call(this,h,u,0,d),this.restitution=0,this.ri=new e,this.rj=new e,this.ni=new e}s.prototype=new p,s.prototype.constructor=s;var r=new e,l=new e,o=new e;s.prototype.computeB=function(h){var u=this.a,d=this.b,x=this.bi,f=this.bj,b=this.ri,H=this.rj,st=r,V=l,k=x.velocity,M=x.angularVelocity;x.force,x.torque;var B=f.velocity,F=f.angularVelocity;f.force,f.torque;var T=o,K=this.jacobianElementA,j=this.jacobianElementB,pt=this.ni;b.cross(pt,st),H.cross(pt,V),pt.negate(K.spatial),st.negate(K.rotational),j.spatial.copy(pt),j.rotational.copy(V),T.copy(f.position),T.vadd(H,T),T.vsub(x.position,T),T.vsub(b,T);var z=pt.dot(T),A=this.restitution+1,_=A*B.dot(pt)-A*k.dot(pt)+F.dot(V)-M.dot(st),q=this.computeGiMf(),g=-z*u-_*d-h*q;return g};var t=new e,i=new e,n=new e,a=new e,c=new e;s.prototype.getImpactVelocityAlongNormal=function(){var h=t,u=i,d=n,x=a,f=c;return this.bi.position.vadd(this.ri,d),this.bj.position.vadd(this.rj,x),this.bi.getVelocityAtWorldPoint(d,h),this.bj.getVelocityAtWorldPoint(x,u),h.vsub(u,f),this.ni.dot(f)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(v,N,at){N.exports=s;var p=v("../math/JacobianElement"),e=v("../math/Vec3");function s(c,h,u,d){this.id=s.id++,this.minForce=typeof u>"u"?-1e6:u,this.maxForce=typeof d>"u"?1e6:d,this.bi=c,this.bj=h,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new p,this.jacobianElementB=new p,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}s.prototype.constructor=s,s.id=0,s.prototype.setSpookParams=function(c,h,u){var d=h,x=c,f=u;this.a=4/(f*(1+4*d)),this.b=4*d/(1+4*d),this.eps=4/(f*f*x*(1+4*d))},s.prototype.computeB=function(c,h,u){var d=this.computeGW(),x=this.computeGq(),f=this.computeGiMf();return-x*c-d*h-f*u},s.prototype.computeGq=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.position,f=d.position;return c.spatial.dot(x)+h.spatial.dot(f)};var r=new e;s.prototype.computeGW=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.velocity,f=d.velocity,b=u.angularVelocity||r,H=d.angularVelocity||r;return c.multiplyVectors(x,b)+h.multiplyVectors(f,H)},s.prototype.computeGWlambda=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.vlambda,f=d.vlambda,b=u.wlambda||r,H=d.wlambda||r;return c.multiplyVectors(x,b)+h.multiplyVectors(f,H)};var l=new e,o=new e,t=new e,i=new e;s.prototype.computeGiMf=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.force,f=u.torque,b=d.force,H=d.torque,st=u.invMassSolve,V=d.invMassSolve;return u.invInertiaWorldSolve?u.invInertiaWorldSolve.vmult(f,t):t.set(0,0,0),d.invInertiaWorldSolve?d.invInertiaWorldSolve.vmult(H,i):i.set(0,0,0),x.mult(st,l),b.mult(V,o),c.multiplyVectors(l,t)+h.multiplyVectors(o,i)};var n=new e;s.prototype.computeGiMGt=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.invMassSolve,f=d.invMassSolve,b=u.invInertiaWorldSolve,H=d.invInertiaWorldSolve,st=x+f;return b&&(b.vmult(c.rotational,n),st+=n.dot(c.rotational)),H&&(H.vmult(h.rotational,n),st+=n.dot(h.rotational)),st};var a=new e;new e,new e,new e,new e,new e,s.prototype.addToWlambda=function(c){var h=this.jacobianElementA,u=this.jacobianElementB,d=this.bi,x=this.bj,f=a;h.spatial.mult(d.invMassSolve*c,f),d.vlambda.vadd(f,d.vlambda),u.spatial.mult(x.invMassSolve*c,f),x.vlambda.vadd(f,x.vlambda),d.invInertiaWorldSolve&&(d.invInertiaWorldSolve.vmult(h.rotational,f),f.mult(c,f),d.wlambda.vadd(f,d.wlambda)),x.invInertiaWorldSolve&&(x.invInertiaWorldSolve.vmult(u.rotational,f),f.mult(c,f),x.wlambda.vadd(f,x.wlambda))},s.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(v,N,at){N.exports=s;var p=v("./Equation"),e=v("../math/Vec3");v("../math/Mat3");function s(o,t,i){p.call(this,o,t,-i,i),this.ri=new e,this.rj=new e,this.t=new e}s.prototype=new p,s.prototype.constructor=s;var r=new e,l=new e;s.prototype.computeB=function(o){this.a;var t=this.b;this.bi,this.bj;var i=this.ri,n=this.rj,a=r,c=l,h=this.t;i.cross(h,a),n.cross(h,c);var u=this.jacobianElementA,d=this.jacobianElementB;h.negate(u.spatial),a.negate(u.rotational),d.spatial.copy(h),d.rotational.copy(c);var x=this.computeGW(),f=this.computeGiMf(),b=-x*t-o*f;return b}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(v,N,at){N.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(o,t,i){i=i||{};var n=typeof i.maxForce<"u"?i.maxForce:1e6;e.call(this,o,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new p(1,0,0),this.axisB=i.axisB?i.axisB.clone():new p(0,1,0),this.maxAngle=Math.PI/2}s.prototype=new e,s.prototype.constructor=s;var r=new p,l=new p;s.prototype.computeB=function(o){var t=this.a,i=this.b,n=this.axisA,a=this.axisB,c=r,h=l,u=this.jacobianElementA,d=this.jacobianElementB;n.cross(a,c),a.cross(n,h),u.rotational.copy(h),d.rotational.copy(c);var x=Math.cos(this.maxAngle)-n.dot(a),f=this.computeGW(),b=this.computeGiMf(),H=-x*t-f*i-o*b;return H}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(v,N,at){N.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(r,l,o){o=typeof o<"u"?o:1e6,e.call(this,r,l,-o,o),this.axisA=new p,this.axisB=new p,this.targetVelocity=0}s.prototype=new e,s.prototype.constructor=s,s.prototype.computeB=function(r){this.a;var l=this.b;this.bi,this.bj;var o=this.axisA,t=this.axisB,i=this.jacobianElementA,n=this.jacobianElementB;i.rotational.copy(o),t.negate(n.rotational);var a=this.computeGW()-this.targetVelocity,c=this.computeGiMf(),h=-a*l-r*c;return h}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(v,N,at){var p=v("../utils/Utils");N.exports=e;function e(s,r,l){l=p.defaults(l,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[s,r],this.friction=l.friction,this.restitution=l.restitution,this.contactEquationStiffness=l.contactEquationStiffness,this.contactEquationRelaxation=l.contactEquationRelaxation,this.frictionEquationStiffness=l.frictionEquationStiffness,this.frictionEquationRelaxation=l.frictionEquationRelaxation}e.idCounter=0},{"../utils/Utils":53}],25:[function(v,N,at){N.exports=p;function p(e){var s="";e=e||{},typeof e=="string"?(s=e,e={}):typeof e=="object"&&(s=""),this.name=s,this.id=p.idCounter++,this.friction=typeof e.friction<"u"?e.friction:-1,this.restitution=typeof e.restitution<"u"?e.restitution:-1}p.idCounter=0},{}],26:[function(v,N,at){N.exports=e;var p=v("./Vec3");function e(){this.spatial=new p,this.rotational=new p}e.prototype.multiplyElement=function(s){return s.spatial.dot(this.spatial)+s.rotational.dot(this.rotational)},e.prototype.multiplyVectors=function(s,r){return s.dot(this.spatial)+r.dot(this.rotational)}},{"./Vec3":30}],27:[function(v,N,at){N.exports=e;var p=v("./Vec3");function e(s){s?this.elements=s:this.elements=[0,0,0,0,0,0,0,0,0]}e.prototype.identity=function(){var s=this.elements;s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=0,s[7]=0,s[8]=1},e.prototype.setZero=function(){var s=this.elements;s[0]=0,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=0,s[6]=0,s[7]=0,s[8]=0},e.prototype.setTrace=function(s){var r=this.elements;r[0]=s.x,r[4]=s.y,r[8]=s.z},e.prototype.getTrace=function(r){var r=r||new p,l=this.elements;r.x=l[0],r.y=l[4],r.z=l[8]},e.prototype.vmult=function(s,r){r=r||new p;var l=this.elements,o=s.x,t=s.y,i=s.z;return r.x=l[0]*o+l[1]*t+l[2]*i,r.y=l[3]*o+l[4]*t+l[5]*i,r.z=l[6]*o+l[7]*t+l[8]*i,r},e.prototype.smult=function(s){for(var r=0;r<this.elements.length;r++)this.elements[r]*=s},e.prototype.mmult=function(s,r){for(var l=r||new e,o=0;o<3;o++)for(var t=0;t<3;t++){for(var i=0,n=0;n<3;n++)i+=s.elements[o+n*3]*this.elements[n+t*3];l.elements[o+t*3]=i}return l},e.prototype.scale=function(s,r){r=r||new e;for(var l=this.elements,o=r.elements,t=0;t!==3;t++)o[3*t+0]=s.x*l[3*t+0],o[3*t+1]=s.y*l[3*t+1],o[3*t+2]=s.z*l[3*t+2];return r},e.prototype.solve=function(s,r){r=r||new p;for(var l=3,o=4,t=[],i=0;i<l*o;i++)t.push(0);var i,n;for(i=0;i<3;i++)for(n=0;n<3;n++)t[i+o*n]=this.elements[i+3*n];t[3+4*0]=s.x,t[3+4*1]=s.y,t[3+4*2]=s.z;var a=3,c=a,h,u=4,d;do{if(i=c-a,t[i+o*i]===0){for(n=i+1;n<c;n++)if(t[i+o*n]!==0){h=u;do d=u-h,t[d+o*i]+=t[d+o*n];while(--h);break}}if(t[i+o*i]!==0)for(n=i+1;n<c;n++){var x=t[i+o*n]/t[i+o*i];h=u;do d=u-h,t[d+o*n]=d<=i?0:t[d+o*n]-t[d+o*i]*x;while(--h)}}while(--a);if(r.z=t[2*o+3]/t[2*o+2],r.y=(t[1*o+3]-t[1*o+2]*r.z)/t[1*o+1],r.x=(t[0*o+3]-t[0*o+2]*r.z-t[0*o+1]*r.y)/t[0*o+0],isNaN(r.x)||isNaN(r.y)||isNaN(r.z)||r.x===1/0||r.y===1/0||r.z===1/0)throw"Could not solve equation! Got x=["+r.toString()+"], b=["+s.toString()+"], A=["+this.toString()+"]";return r},e.prototype.e=function(s,r,l){if(l===void 0)return this.elements[r+3*s];this.elements[r+3*s]=l},e.prototype.copy=function(s){for(var r=0;r<s.elements.length;r++)this.elements[r]=s.elements[r];return this},e.prototype.toString=function(){for(var s="",r=",",l=0;l<9;l++)s+=this.elements[l]+r;return s},e.prototype.reverse=function(s){s=s||new e;for(var r=3,l=6,o=[],t=0;t<r*l;t++)o.push(0);var t,i;for(t=0;t<3;t++)for(i=0;i<3;i++)o[t+l*i]=this.elements[t+3*i];o[3+6*0]=1,o[3+6*1]=0,o[3+6*2]=0,o[4+6*0]=0,o[4+6*1]=1,o[4+6*2]=0,o[5+6*0]=0,o[5+6*1]=0,o[5+6*2]=1;var n=3,a=n,c,h=l,u;do{if(t=a-n,o[t+l*t]===0){for(i=t+1;i<a;i++)if(o[t+l*i]!==0){c=h;do u=h-c,o[u+l*t]+=o[u+l*i];while(--c);break}}if(o[t+l*t]!==0)for(i=t+1;i<a;i++){var d=o[t+l*i]/o[t+l*t];c=h;do u=h-c,o[u+l*i]=u<=t?0:o[u+l*i]-o[u+l*t]*d;while(--c)}}while(--n);t=2;do{i=t-1;do{var d=o[t+l*i]/o[t+l*t];c=l;do u=l-c,o[u+l*i]=o[u+l*i]-o[u+l*t]*d;while(--c)}while(i--)}while(--t);t=2;do{var d=1/o[t+l*t];c=l;do u=l-c,o[u+l*t]=o[u+l*t]*d;while(--c)}while(t--);t=2;do{i=2;do{if(u=o[r+i+l*t],isNaN(u)||u===1/0)throw"Could not reverse! A=["+this.toString()+"]";s.e(t,i,u)}while(i--)}while(t--);return s},e.prototype.setRotationFromQuaternion=function(s){var r=s.x,l=s.y,o=s.z,t=s.w,i=r+r,n=l+l,a=o+o,c=r*i,h=r*n,u=r*a,d=l*n,x=l*a,f=o*a,b=t*i,H=t*n,st=t*a,V=this.elements;return V[3*0+0]=1-(d+f),V[3*0+1]=h-st,V[3*0+2]=u+H,V[3*1+0]=h+st,V[3*1+1]=1-(c+f),V[3*1+2]=x-b,V[3*2+0]=u-H,V[3*2+1]=x+b,V[3*2+2]=1-(c+d),this},e.prototype.transpose=function(s){s=s||new e;for(var r=s.elements,l=this.elements,o=0;o!==3;o++)for(var t=0;t!==3;t++)r[3*o+t]=l[3*t+o];return s}},{"./Vec3":30}],28:[function(v,N,at){N.exports=e;var p=v("./Vec3");function e(i,n,a,c){this.x=i!==void 0?i:0,this.y=n!==void 0?n:0,this.z=a!==void 0?a:0,this.w=c!==void 0?c:1}e.prototype.set=function(i,n,a,c){this.x=i,this.y=n,this.z=a,this.w=c},e.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},e.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},e.prototype.setFromAxisAngle=function(i,n){var a=Math.sin(n*.5);this.x=i.x*a,this.y=i.y*a,this.z=i.z*a,this.w=Math.cos(n*.5)},e.prototype.toAxisAngle=function(i){i=i||new p,this.normalize();var n=2*Math.acos(this.w),a=Math.sqrt(1-this.w*this.w);return a<.001?(i.x=this.x,i.y=this.y,i.z=this.z):(i.x=this.x/a,i.y=this.y/a,i.z=this.z/a),[i,n]};var s=new p,r=new p;e.prototype.setFromVectors=function(i,n){if(i.isAntiparallelTo(n)){var a=s,c=r;i.tangents(a,c),this.setFromAxisAngle(a,Math.PI)}else{var h=i.cross(n);this.x=h.x,this.y=h.y,this.z=h.z,this.w=Math.sqrt(Math.pow(i.norm(),2)*Math.pow(n.norm(),2))+i.dot(n),this.normalize()}};var l=new p,o=new p,t=new p;e.prototype.mult=function(i,n){n=n||new e;var a=this.w,c=l,h=o,u=t;return c.set(this.x,this.y,this.z),h.set(i.x,i.y,i.z),n.w=a*i.w-c.dot(h),c.cross(h,u),n.x=a*h.x+i.w*c.x+u.x,n.y=a*h.y+i.w*c.y+u.y,n.z=a*h.z+i.w*c.z+u.z,n},e.prototype.inverse=function(i){var n=this.x,a=this.y,c=this.z,h=this.w;i=i||new e,this.conjugate(i);var u=1/(n*n+a*a+c*c+h*h);return i.x*=u,i.y*=u,i.z*=u,i.w*=u,i},e.prototype.conjugate=function(i){return i=i||new e,i.x=-this.x,i.y=-this.y,i.z=-this.z,i.w=this.w,i},e.prototype.normalize=function(){var i=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);i===0?(this.x=0,this.y=0,this.z=0,this.w=0):(i=1/i,this.x*=i,this.y*=i,this.z*=i,this.w*=i)},e.prototype.normalizeFast=function(){var i=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;i===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=i,this.y*=i,this.z*=i,this.w*=i)},e.prototype.vmult=function(i,n){n=n||new p;var a=i.x,c=i.y,h=i.z,u=this.x,d=this.y,x=this.z,f=this.w,b=f*a+d*h-x*c,H=f*c+x*a-u*h,st=f*h+u*c-d*a,V=-u*a-d*c-x*h;return n.x=b*f+V*-u+H*-x-st*-d,n.y=H*f+V*-d+st*-u-b*-x,n.z=st*f+V*-x+b*-d-H*-u,n},e.prototype.copy=function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w,this},e.prototype.toEuler=function(i,n){n=n||"YZX";var a,c,h,u=this.x,d=this.y,x=this.z,f=this.w;switch(n){case"YZX":var b=u*d+x*f;if(b>.499&&(a=2*Math.atan2(u,f),c=Math.PI/2,h=0),b<-.499&&(a=-2*Math.atan2(u,f),c=-Math.PI/2,h=0),isNaN(a)){var H=u*u,st=d*d,V=x*x;a=Math.atan2(2*d*f-2*u*x,1-2*st-2*V),c=Math.asin(2*b),h=Math.atan2(2*u*f-2*d*x,1-2*H-2*V)}break;default:throw new Error("Euler order "+n+" not supported yet.")}i.y=a,i.z=c,i.x=h},e.prototype.setFromEuler=function(i,n,a,c){c=c||"XYZ";var h=Math.cos(i/2),u=Math.cos(n/2),d=Math.cos(a/2),x=Math.sin(i/2),f=Math.sin(n/2),b=Math.sin(a/2);return c==="XYZ"?(this.x=x*u*d+h*f*b,this.y=h*f*d-x*u*b,this.z=h*u*b+x*f*d,this.w=h*u*d-x*f*b):c==="YXZ"?(this.x=x*u*d+h*f*b,this.y=h*f*d-x*u*b,this.z=h*u*b-x*f*d,this.w=h*u*d+x*f*b):c==="ZXY"?(this.x=x*u*d-h*f*b,this.y=h*f*d+x*u*b,this.z=h*u*b+x*f*d,this.w=h*u*d-x*f*b):c==="ZYX"?(this.x=x*u*d-h*f*b,this.y=h*f*d+x*u*b,this.z=h*u*b-x*f*d,this.w=h*u*d+x*f*b):c==="YZX"?(this.x=x*u*d+h*f*b,this.y=h*f*d+x*u*b,this.z=h*u*b-x*f*d,this.w=h*u*d-x*f*b):c==="XZY"&&(this.x=x*u*d-h*f*b,this.y=h*f*d-x*u*b,this.z=h*u*b+x*f*d,this.w=h*u*d+x*f*b),this},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(v,N,at){var p=v("./Vec3"),e=v("./Quaternion");N.exports=s;function s(l){l=l||{},this.position=new p,l.position&&this.position.copy(l.position),this.quaternion=new e,l.quaternion&&this.quaternion.copy(l.quaternion)}var r=new e;s.pointToLocalFrame=function(l,o,t,n){var n=n||new p;return t.vsub(l,n),o.conjugate(r),r.vmult(n,n),n},s.prototype.pointToLocal=function(l,o){return s.pointToLocalFrame(this.position,this.quaternion,l,o)},s.pointToWorldFrame=function(l,o,t,n){var n=n||new p;return o.vmult(t,n),n.vadd(l,n),n},s.prototype.pointToWorld=function(l,o){return s.pointToWorldFrame(this.position,this.quaternion,l,o)},s.prototype.vectorToWorldFrame=function(l,t){var t=t||new p;return this.quaternion.vmult(l,t),t},s.vectorToWorldFrame=function(l,o,t){return l.vmult(o,t),t},s.vectorToLocalFrame=function(l,o,t,n){var n=n||new p;return o.w*=-1,o.vmult(t,n),o.w*=-1,n}},{"./Quaternion":28,"./Vec3":30}],30:[function(v,N,at){N.exports=e;var p=v("./Mat3");function e(o,t,i){this.x=o||0,this.y=t||0,this.z=i||0}e.ZERO=new e(0,0,0),e.UNIT_X=new e(1,0,0),e.UNIT_Y=new e(0,1,0),e.UNIT_Z=new e(0,0,1),e.prototype.cross=function(o,t){var i=o.x,n=o.y,a=o.z,c=this.x,h=this.y,u=this.z;return t=t||new e,t.x=h*a-u*n,t.y=u*i-c*a,t.z=c*n-h*i,t},e.prototype.set=function(o,t,i){return this.x=o,this.y=t,this.z=i,this},e.prototype.setZero=function(){this.x=this.y=this.z=0},e.prototype.vadd=function(o,t){if(t)t.x=o.x+this.x,t.y=o.y+this.y,t.z=o.z+this.z;else return new e(this.x+o.x,this.y+o.y,this.z+o.z)},e.prototype.vsub=function(o,t){if(t)t.x=this.x-o.x,t.y=this.y-o.y,t.z=this.z-o.z;else return new e(this.x-o.x,this.y-o.y,this.z-o.z)},e.prototype.crossmat=function(){return new p([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},e.prototype.normalize=function(){var o=this.x,t=this.y,i=this.z,n=Math.sqrt(o*o+t*t+i*i);if(n>0){var a=1/n;this.x*=a,this.y*=a,this.z*=a}else this.x=0,this.y=0,this.z=0;return n},e.prototype.unit=function(o){o=o||new e;var t=this.x,i=this.y,n=this.z,a=Math.sqrt(t*t+i*i+n*n);return a>0?(a=1/a,o.x=t*a,o.y=i*a,o.z=n*a):(o.x=1,o.y=0,o.z=0),o},e.prototype.norm=function(){var o=this.x,t=this.y,i=this.z;return Math.sqrt(o*o+t*t+i*i)},e.prototype.length=e.prototype.norm,e.prototype.norm2=function(){return this.dot(this)},e.prototype.lengthSquared=e.prototype.norm2,e.prototype.distanceTo=function(o){var t=this.x,i=this.y,n=this.z,a=o.x,c=o.y,h=o.z;return Math.sqrt((a-t)*(a-t)+(c-i)*(c-i)+(h-n)*(h-n))},e.prototype.distanceSquared=function(o){var t=this.x,i=this.y,n=this.z,a=o.x,c=o.y,h=o.z;return(a-t)*(a-t)+(c-i)*(c-i)+(h-n)*(h-n)},e.prototype.mult=function(o,t){t=t||new e;var i=this.x,n=this.y,a=this.z;return t.x=o*i,t.y=o*n,t.z=o*a,t},e.prototype.scale=e.prototype.mult,e.prototype.dot=function(o){return this.x*o.x+this.y*o.y+this.z*o.z},e.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},e.prototype.negate=function(o){return o=o||new e,o.x=-this.x,o.y=-this.y,o.z=-this.z,o};var s=new e,r=new e;e.prototype.tangents=function(o,t){var i=this.norm();if(i>0){var n=s,a=1/i;n.set(this.x*a,this.y*a,this.z*a);var c=r;Math.abs(n.x)<.9?(c.set(1,0,0),n.cross(c,o)):(c.set(0,1,0),n.cross(c,o)),n.cross(o,t)}else o.set(1,0,0),t.set(0,1,0)},e.prototype.toString=function(){return this.x+","+this.y+","+this.z},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e.prototype.copy=function(o){return this.x=o.x,this.y=o.y,this.z=o.z,this},e.prototype.lerp=function(o,t,i){var n=this.x,a=this.y,c=this.z;i.x=n+(o.x-n)*t,i.y=a+(o.y-a)*t,i.z=c+(o.z-c)*t},e.prototype.almostEquals=function(o,t){return t===void 0&&(t=1e-6),!(Math.abs(this.x-o.x)>t||Math.abs(this.y-o.y)>t||Math.abs(this.z-o.z)>t)},e.prototype.almostZero=function(o){return o===void 0&&(o=1e-6),!(Math.abs(this.x)>o||Math.abs(this.y)>o||Math.abs(this.z)>o)};var l=new e;e.prototype.isAntiparallelTo=function(o,t){return this.negate(l),l.almostEquals(o,t)},e.prototype.clone=function(){return new e(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(v,N,at){N.exports=t;var p=v("../utils/EventTarget");v("../shapes/Shape");var e=v("../math/Vec3"),s=v("../math/Mat3"),r=v("../math/Quaternion");v("../material/Material");var l=v("../collision/AABB"),o=v("../shapes/Box");function t(B){B=B||{},p.apply(this),this.id=t.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new e,this.collisionFilterGroup=typeof B.collisionFilterGroup=="number"?B.collisionFilterGroup:1,this.collisionFilterMask=typeof B.collisionFilterMask=="number"?B.collisionFilterMask:1,this.collisionResponse=!0,this.position=new e,B.position&&this.position.copy(B.position),this.previousPosition=new e,this.initPosition=new e,this.velocity=new e,B.velocity&&this.velocity.copy(B.velocity),this.initVelocity=new e,this.force=new e;var F=typeof B.mass=="number"?B.mass:0;this.mass=F,this.invMass=F>0?1/F:0,this.material=B.material||null,this.linearDamping=typeof B.linearDamping=="number"?B.linearDamping:.01,this.type=F<=0?t.STATIC:t.DYNAMIC,typeof B.type==typeof t.STATIC&&(this.type=B.type),this.allowSleep=typeof B.allowSleep<"u"?B.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit=typeof B.sleepSpeedLimit<"u"?B.sleepSpeedLimit:.1,this.sleepTimeLimit=typeof B.sleepTimeLimit<"u"?B.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new e,this.quaternion=new r,B.quaternion&&this.quaternion.copy(B.quaternion),this.initQuaternion=new r,this.angularVelocity=new e,B.angularVelocity&&this.angularVelocity.copy(B.angularVelocity),this.initAngularVelocity=new e,this.interpolatedPosition=new e,this.interpolatedQuaternion=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new e,this.invInertia=new e,this.invInertiaWorld=new s,this.invMassSolve=0,this.invInertiaSolve=new e,this.invInertiaWorldSolve=new s,this.fixedRotation=typeof B.fixedRotation<"u"?B.fixedRotation:!1,this.angularDamping=typeof B.angularDamping<"u"?B.angularDamping:.01,this.aabb=new l,this.aabbNeedsUpdate=!0,this.wlambda=new e,B.shape&&this.addShape(B.shape),this.updateMassProperties()}t.prototype=new p,t.prototype.constructor=t,t.DYNAMIC=1,t.STATIC=2,t.KINEMATIC=4,t.AWAKE=0,t.SLEEPY=1,t.SLEEPING=2,t.idCounter=0,t.prototype.wakeUp=function(){var B=this.sleepState;this.sleepState=0,B===t.SLEEPING&&this.dispatchEvent({type:"wakeup"})},t.prototype.sleep=function(){this.sleepState=t.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},t.sleepyEvent={type:"sleepy"},t.sleepEvent={type:"sleep"},t.prototype.sleepTick=function(B){if(this.allowSleep){var F=this.sleepState,T=this.velocity.norm2()+this.angularVelocity.norm2(),K=Math.pow(this.sleepSpeedLimit,2);F===t.AWAKE&&T<K?(this.sleepState=t.SLEEPY,this.timeLastSleepy=B,this.dispatchEvent(t.sleepyEvent)):F===t.SLEEPY&&T>K?this.wakeUp():F===t.SLEEPY&&B-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(t.sleepEvent))}},t.prototype.updateSolveMassProperties=function(){this.sleepState===t.SLEEPING||this.type===t.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},t.prototype.pointToLocalFrame=function(B,T){var T=T||new e;return B.vsub(this.position,T),this.quaternion.conjugate().vmult(T,T),T},t.prototype.vectorToLocalFrame=function(B,T){var T=T||new e;return this.quaternion.conjugate().vmult(B,T),T},t.prototype.pointToWorldFrame=function(B,T){var T=T||new e;return this.quaternion.vmult(B,T),T.vadd(this.position,T),T},t.prototype.vectorToWorldFrame=function(B,T){var T=T||new e;return this.quaternion.vmult(B,T),T};var i=new e,n=new r;t.prototype.addShape=function(B,F,T){var K=new e,j=new r;return F&&K.copy(F),T&&j.copy(T),this.shapes.push(B),this.shapeOffsets.push(K),this.shapeOrientations.push(j),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},t.prototype.updateBoundingRadius=function(){for(var B=this.shapes,F=this.shapeOffsets,T=B.length,K=0,j=0;j!==T;j++){var pt=B[j];pt.updateBoundingSphereRadius();var z=F[j].norm(),A=pt.boundingSphereRadius;z+A>K&&(K=z+A)}this.boundingRadius=K};var a=new l;t.prototype.computeAABB=function(){for(var B=this.shapes,F=this.shapeOffsets,T=this.shapeOrientations,K=B.length,j=i,pt=n,z=this.quaternion,A=this.aabb,_=a,q=0;q!==K;q++){var g=B[q];T[q].mult(z,pt),pt.vmult(F[q],j),j.vadd(this.position,j),g.calculateWorldAABB(j,pt,_.lowerBound,_.upperBound),q===0?A.copy(_):A.extend(_)}this.aabbNeedsUpdate=!1};var c=new s,h=new s;new s,t.prototype.updateInertiaWorld=function(B){var F=this.invInertia;if(!(F.x===F.y&&F.y===F.z&&!B)){var T=c,K=h;T.setRotationFromQuaternion(this.quaternion),T.transpose(K),T.scale(F,T),T.mmult(K,this.invInertiaWorld)}};var u=new e,d=new e;t.prototype.applyForce=function(B,F){if(this.type===t.DYNAMIC){var T=u;F.vsub(this.position,T);var K=d;T.cross(B,K),this.force.vadd(B,this.force),this.torque.vadd(K,this.torque)}};var x=new e,f=new e;t.prototype.applyLocalForce=function(B,F){if(this.type===t.DYNAMIC){var T=x,K=f;this.vectorToWorldFrame(B,T),this.pointToWorldFrame(F,K),this.applyForce(T,K)}};var b=new e,H=new e,st=new e;t.prototype.applyImpulse=function(B,F){if(this.type===t.DYNAMIC){var T=b;F.vsub(this.position,T);var K=H;K.copy(B),K.mult(this.invMass,K),this.velocity.vadd(K,this.velocity);var j=st;T.cross(B,j),this.invInertiaWorld.vmult(j,j),this.angularVelocity.vadd(j,this.angularVelocity)}};var V=new e,k=new e;t.prototype.applyLocalImpulse=function(B,F){if(this.type===t.DYNAMIC){var T=V,K=k;this.vectorToWorldFrame(B,T),this.pointToWorldFrame(F,K),this.applyImpulse(T,K)}};var M=new e;t.prototype.updateMassProperties=function(){var B=M;this.invMass=this.mass>0?1/this.mass:0;var F=this.inertia,T=this.fixedRotation;this.computeAABB(),B.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),o.calculateInertia(B,this.mass,F),this.invInertia.set(F.x>0&&!T?1/F.x:0,F.y>0&&!T?1/F.y:0,F.z>0&&!T?1/F.z:0),this.updateInertiaWorld(!0)},t.prototype.getVelocityAtWorldPoint=function(B,F){var T=new e;return B.vsub(this.position,T),this.angularVelocity.cross(T,F),this.velocity.vadd(F,F),F}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(v,N,at){v("./Body");var p=v("../math/Vec3"),e=v("../math/Quaternion");v("../collision/RaycastResult");var s=v("../collision/Ray"),r=v("../objects/WheelInfo");N.exports=l;function l(z){this.chassisBody=z.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=typeof z.indexRightAxis<"u"?z.indexRightAxis:1,this.indexForwardAxis=typeof z.indexForwardAxis<"u"?z.indexForwardAxis:0,this.indexUpAxis=typeof z.indexUpAxis<"u"?z.indexUpAxis:2}new p,new p,new p;var o=new p,t=new p,i=new p;new s,l.prototype.addWheel=function(z){z=z||{};var A=new r(z),_=this.wheelInfos.length;return this.wheelInfos.push(A),_},l.prototype.setSteeringValue=function(z,A){var _=this.wheelInfos[A];_.steering=z},new p,l.prototype.applyEngineForce=function(z,A){this.wheelInfos[A].engineForce=z},l.prototype.setBrake=function(z,A){this.wheelInfos[A].brake=z},l.prototype.addToWorld=function(z){this.constraints,z.add(this.chassisBody);var A=this;this.preStepCallback=function(){A.updateVehicle(z.dt)},z.addEventListener("preStep",this.preStepCallback),this.world=z},l.prototype.getVehicleAxisWorld=function(z,A){A.set(z===0?1:0,z===1?1:0,z===2?1:0),this.chassisBody.vectorToWorldFrame(A,A)},l.prototype.updateVehicle=function(z){for(var A=this.wheelInfos,_=A.length,q=this.chassisBody,g=0;g<_;g++)this.updateWheelTransform(g);this.currentVehicleSpeedKmHour=3.6*q.velocity.norm();var R=new p;this.getVehicleAxisWorld(this.indexForwardAxis,R),R.dot(q.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var g=0;g<_;g++)this.castRay(A[g]);this.updateSuspension(z);for(var w=new p,m=new p,g=0;g<_;g++){var y=A[g],C=y.suspensionForce;C>y.maxSuspensionForce&&(C=y.maxSuspensionForce),y.raycastResult.hitNormalWorld.scale(C*z,w),y.raycastResult.hitPointWorld.vsub(q.position,m),q.applyImpulse(w,y.raycastResult.hitPointWorld)}this.updateFriction(z);var G=new p,W=new p,E=new p;for(g=0;g<_;g++){var y=A[g];q.getVelocityAtWorldPoint(y.chassisConnectionPointWorld,E);var L=1;switch(this.indexUpAxis){case 1:L=-1;break}if(y.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,W);var X=W.dot(y.raycastResult.hitNormalWorld);y.raycastResult.hitNormalWorld.scale(X,G),W.vsub(G,W);var ut=W.dot(E);y.deltaRotation=L*ut*z/y.radius}(y.sliding||!y.isInContact)&&y.engineForce!==0&&y.useCustomSlidingRotationalSpeed&&(y.deltaRotation=(y.engineForce>0?1:-1)*y.customSlidingRotationalSpeed*z),Math.abs(y.brake)>Math.abs(y.engineForce)&&(y.deltaRotation=0),y.rotation+=y.deltaRotation,y.deltaRotation*=.99}},l.prototype.updateSuspension=function(z){for(var A=this.chassisBody,_=A.mass,q=this.wheelInfos,g=q.length,R=0;R<g;R++){var w=q[R];if(w.isInContact){var m,y=w.suspensionRestLength,C=w.suspensionLength,G=y-C;m=w.suspensionStiffness*G*w.clippedInvContactDotSuspension;var W=w.suspensionRelativeVelocity,E;W<0?E=w.dampingCompression:E=w.dampingRelaxation,m-=E*W,w.suspensionForce=m*_,w.suspensionForce<0&&(w.suspensionForce=0)}else w.suspensionForce=0}},l.prototype.removeFromWorld=function(z){this.constraints,z.remove(this.chassisBody),z.removeEventListener("preStep",this.preStepCallback),this.world=null};var n=new p,a=new p;l.prototype.castRay=function(z){var A=n,_=a;this.updateWheelTransformWorld(z);var q=this.chassisBody,g=-1,R=z.suspensionRestLength+z.radius;z.directionWorld.scale(R,A);var w=z.chassisConnectionPointWorld;w.vadd(A,_);var m=z.raycastResult;m.reset();var y=q.collisionResponse;q.collisionResponse=!1,this.world.rayTest(w,_,m),q.collisionResponse=y;var C=m.body;if(z.raycastResult.groundObject=0,C){g=m.distance,z.raycastResult.hitNormalWorld=m.hitNormalWorld,z.isInContact=!0;var G=m.distance;z.suspensionLength=G-z.radius;var W=z.suspensionRestLength-z.maxSuspensionTravel,E=z.suspensionRestLength+z.maxSuspensionTravel;z.suspensionLength<W&&(z.suspensionLength=W),z.suspensionLength>E&&(z.suspensionLength=E,z.raycastResult.reset());var L=z.raycastResult.hitNormalWorld.dot(z.directionWorld),X=new p;q.getVelocityAtWorldPoint(z.raycastResult.hitPointWorld,X);var ut=z.raycastResult.hitNormalWorld.dot(X);if(L>=-.1)z.suspensionRelativeVelocity=0,z.clippedInvContactDotSuspension=1/.1;else{var lt=-1/L;z.suspensionRelativeVelocity=ut*lt,z.clippedInvContactDotSuspension=lt}}else z.suspensionLength=z.suspensionRestLength+0*z.maxSuspensionTravel,z.suspensionRelativeVelocity=0,z.directionWorld.scale(-1,z.raycastResult.hitNormalWorld),z.clippedInvContactDotSuspension=1;return g},l.prototype.updateWheelTransformWorld=function(z){z.isInContact=!1;var A=this.chassisBody;A.pointToWorldFrame(z.chassisConnectionPointLocal,z.chassisConnectionPointWorld),A.vectorToWorldFrame(z.directionLocal,z.directionWorld),A.vectorToWorldFrame(z.axleLocal,z.axleWorld)},l.prototype.updateWheelTransform=function(z){var A=o,_=t,q=i,g=this.wheelInfos[z];this.updateWheelTransformWorld(g),g.directionLocal.scale(-1,A),_.copy(g.axleLocal),A.cross(_,q),q.normalize(),_.normalize();var R=g.steering,w=new e;w.setFromAxisAngle(A,R);var m=new e;m.setFromAxisAngle(_,g.rotation);var y=g.worldTransform.quaternion;this.chassisBody.quaternion.mult(w,y),y.mult(m,y),y.normalize();var C=g.worldTransform.position;C.copy(g.directionWorld),C.scale(g.suspensionLength,C),C.vadd(g.chassisConnectionPointWorld,C)};var c=[new p(1,0,0),new p(0,1,0),new p(0,0,1)];l.prototype.getWheelTransformWorld=function(z){return this.wheelInfos[z].worldTransform};var h=new p,u=[],d=[],x=1;l.prototype.updateFriction=function(z){for(var A=h,_=this.wheelInfos,q=_.length,g=this.chassisBody,R=d,w=u,m=0;m<q;m++){var y=_[m],C=y.raycastResult.body;y.sideImpulse=0,y.forwardImpulse=0,R[m]||(R[m]=new p),w[m]||(w[m]=new p)}for(var m=0;m<q;m++){var y=_[m],C=y.raycastResult.body;if(C){var G=w[m],W=this.getWheelTransformWorld(m);W.vectorToWorldFrame(c[this.indexRightAxis],G);var E=y.raycastResult.hitNormalWorld,L=G.dot(E);E.scale(L,A),G.vsub(A,G),G.normalize(),E.cross(G,R[m]),R[m].normalize(),y.sideImpulse=pt(g,y.raycastResult.hitPointWorld,C,y.raycastResult.hitPointWorld,G),y.sideImpulse*=x}}var X=1,ut=.5;this.sliding=!1;for(var m=0;m<q;m++){var y=_[m],C=y.raycastResult.body,lt=0;if(y.slipInfo=1,C){var nt=0,O=y.brake?y.brake:nt;lt=st(g,C,y.raycastResult.hitPointWorld,R[m],O),lt+=y.engineForce*z;var Q=O/lt;y.slipInfo*=Q}if(y.forwardImpulse=0,y.skidInfo=1,C){y.skidInfo=1;var bt=y.suspensionForce*z*y.frictionSlip,ft=bt,zt=bt*ft;y.forwardImpulse=lt;var ct=y.forwardImpulse*ut,St=y.sideImpulse*X,Rt=ct*ct+St*St;if(y.sliding=!1,Rt>zt){this.sliding=!0,y.sliding=!0;var Q=bt/Math.sqrt(Rt);y.skidInfo*=Q}}}if(this.sliding)for(var m=0;m<q;m++){var y=_[m];y.sideImpulse!==0&&y.skidInfo<1&&(y.forwardImpulse*=y.skidInfo,y.sideImpulse*=y.skidInfo)}for(var m=0;m<q;m++){var y=_[m],Mt=new p;if(Mt.copy(y.raycastResult.hitPointWorld),y.forwardImpulse!==0){var Vt=new p;R[m].scale(y.forwardImpulse,Vt),g.applyImpulse(Vt,Mt)}if(y.sideImpulse!==0){var C=y.raycastResult.body,At=new p;At.copy(y.raycastResult.hitPointWorld);var Tt=new p;w[m].scale(y.sideImpulse,Tt),g.pointToLocalFrame(Mt,Mt),Mt["xyz"[this.indexUpAxis]]*=y.rollInfluence,g.pointToWorldFrame(Mt,Mt),g.applyImpulse(Tt,Mt),Tt.scale(-1,Tt),C.applyImpulse(Tt,At)}}};var f=new p,b=new p,H=new p;function st(z,A,_,q,g){var R=0,w=_,m=f,y=b,C=H;z.getVelocityAtWorldPoint(w,m),A.getVelocityAtWorldPoint(w,y),m.vsub(y,C);var G=q.dot(C),W=F(z,_,q),E=F(A,_,q),L=1,X=L/(W+E);return R=-G*X,g<R&&(R=g),R<-g&&(R=-g),R}var V=new p,k=new p,M=new p,B=new p;function F(z,A,_){var q=V,g=k,R=M,w=B;return A.vsub(z.position,q),q.cross(_,g),z.invInertiaWorld.vmult(g,w),w.cross(q,R),z.invMass+_.dot(R)}var T=new p,K=new p,j=new p;function pt(z,A,_,q,g,L){var w=g.norm2();if(w>1.1)return 0;var m=T,y=K,C=j;z.getVelocityAtWorldPoint(A,m),_.getVelocityAtWorldPoint(q,y),m.vsub(y,C);var G=g.dot(C),W=.2,E=1/(z.invMass+_.invMass),L=-W*G*E;return L}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(v,N,at){var p=v("./Body"),e=v("../shapes/Sphere"),s=v("../shapes/Box"),r=v("../math/Vec3"),l=v("../constraints/HingeConstraint");N.exports=o;function o(n){if(this.wheelBodies=[],this.coordinateSystem=typeof n.coordinateSystem>"u"?new r(1,2,3):n.coordinateSystem.clone(),this.chassisBody=n.chassisBody,!this.chassisBody){var a=new s(new r(5,2,.5));this.chassisBody=new p(1,a)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}o.prototype.addWheel=function(n){n=n||{};var a=n.body;a||(a=new p(1,new e(1.2))),this.wheelBodies.push(a),this.wheelForces.push(0),new r;var c=typeof n.position<"u"?n.position.clone():new r,h=new r;this.chassisBody.pointToWorldFrame(c,h),a.position.set(h.x,h.y,h.z);var u=typeof n.axis<"u"?n.axis.clone():new r(0,1,0);this.wheelAxes.push(u);var d=new l(this.chassisBody,a,{pivotA:c,axisA:u,pivotB:r.ZERO,axisB:u,collideConnected:!1});return this.constraints.push(d),this.wheelBodies.length-1},o.prototype.setSteeringValue=function(n,a){var c=this.wheelAxes[a],h=Math.cos(n),u=Math.sin(n),d=c.x,x=c.y;this.constraints[a].axisA.set(h*d-u*x,u*d+h*x,0)},o.prototype.setMotorSpeed=function(n,a){var c=this.constraints[a];c.enableMotor(),c.motorTargetVelocity=n},o.prototype.disableMotor=function(n){var a=this.constraints[n];a.disableMotor()};var t=new r;o.prototype.setWheelForce=function(n,a){this.wheelForces[a]=n},o.prototype.applyWheelForce=function(n,a){var c=this.wheelAxes[a],h=this.wheelBodies[a],u=h.torque;c.scale(n,t),h.vectorToWorldFrame(t,t),u.vadd(t,u)},o.prototype.addToWorld=function(n){for(var a=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),h=0;h<c.length;h++)n.add(c[h]);for(var h=0;h<a.length;h++)n.addConstraint(a[h]);n.addEventListener("preStep",this._update.bind(this))},o.prototype._update=function(){for(var n=this.wheelForces,a=0;a<n.length;a++)this.applyWheelForce(n[a],a)},o.prototype.removeFromWorld=function(n){for(var a=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),h=0;h<c.length;h++)n.remove(c[h]);for(var h=0;h<a.length;h++)n.removeConstraint(a[h])};var i=new r;o.prototype.getWheelSpeed=function(n){var a=this.wheelAxes[n],c=this.wheelBodies[n],h=c.angularVelocity;return this.chassisBody.vectorToWorldFrame(a,i),h.dot(i)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(v,N,at){N.exports=e,v("../shapes/Shape");var p=v("../math/Vec3");v("../math/Quaternion"),v("../shapes/Particle"),v("../objects/Body"),v("../material/Material");function e(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e.prototype.add=function(a){this.particles.push(a),this.neighbors.length<this.particles.length&&this.neighbors.push([])},e.prototype.remove=function(a){var c=this.particles.indexOf(a);c!==-1&&(this.particles.splice(c,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var s=new p;e.prototype.getNeighbors=function(a,c){for(var h=this.particles.length,u=a.id,d=this.smoothingRadius*this.smoothingRadius,x=s,f=0;f!==h;f++){var b=this.particles[f];b.position.vsub(a.position,x),u!==b.id&&x.norm2()<d&&c.push(b)}};var r=new p,l=new p,o=new p,t=new p,i=new p,n=new p;e.prototype.update=function(){for(var a=this.particles.length,c=r,h=this.speedOfSound,u=this.eps,d=0;d!==a;d++){var x=this.particles[d],f=this.neighbors[d];f.length=0,this.getNeighbors(x,f),f.push(this.particles[d]);for(var b=f.length,H=0,st=0;st!==b;st++){x.position.vsub(f[st].position,c);var V=c.norm(),k=this.w(V);H+=f[st].mass*k}this.densities[d]=H,this.pressures[d]=h*h*(this.densities[d]-this.density)}for(var M=l,B=o,F=t,T=i,K=n,d=0;d!==a;d++){var j=this.particles[d];M.set(0,0,0),B.set(0,0,0);for(var pt,z,f=this.neighbors[d],b=f.length,st=0;st!==b;st++){var A=f[st];j.position.vsub(A.position,T);var _=T.norm();pt=-A.mass*(this.pressures[d]/(this.densities[d]*this.densities[d]+u)+this.pressures[st]/(this.densities[st]*this.densities[st]+u)),this.gradw(T,F),F.mult(pt,F),M.vadd(F,M),A.velocity.vsub(j.velocity,K),K.mult(1/(1e-4+this.densities[d]*this.densities[st])*this.viscosity*A.mass,K),z=this.nablaw(_),K.mult(z,K),B.vadd(K,B)}B.mult(j.mass,B),M.mult(j.mass,M),j.force.vadd(B,j.force),j.force.vadd(M,j.force)}},e.prototype.w=function(a){var c=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(c,9))*Math.pow(c*c-a*a,3)},e.prototype.gradw=function(a,c){var h=a.norm(),u=this.smoothingRadius;a.mult(945/(32*Math.PI*Math.pow(u,9))*Math.pow(u*u-h*h,2),c)},e.prototype.nablaw=function(a){var c=this.smoothingRadius,h=945/(32*Math.PI*Math.pow(c,9))*(c*c-a*a)*(7*a*a-3*c*c);return h}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(v,N,at){var p=v("../math/Vec3");N.exports=e;function e(d,x,f){f=f||{},this.restLength=typeof f.restLength=="number"?f.restLength:1,this.stiffness=f.stiffness||100,this.damping=f.damping||1,this.bodyA=d,this.bodyB=x,this.localAnchorA=new p,this.localAnchorB=new p,f.localAnchorA&&this.localAnchorA.copy(f.localAnchorA),f.localAnchorB&&this.localAnchorB.copy(f.localAnchorB),f.worldAnchorA&&this.setWorldAnchorA(f.worldAnchorA),f.worldAnchorB&&this.setWorldAnchorB(f.worldAnchorB)}e.prototype.setWorldAnchorA=function(d){this.bodyA.pointToLocalFrame(d,this.localAnchorA)},e.prototype.setWorldAnchorB=function(d){this.bodyB.pointToLocalFrame(d,this.localAnchorB)},e.prototype.getWorldAnchorA=function(d){this.bodyA.pointToWorldFrame(this.localAnchorA,d)},e.prototype.getWorldAnchorB=function(d){this.bodyB.pointToWorldFrame(this.localAnchorB,d)};var s=new p,r=new p,l=new p,o=new p,t=new p,i=new p,n=new p,a=new p,c=new p,h=new p,u=new p;e.prototype.applyForce=function(){var d=this.stiffness,x=this.damping,f=this.restLength,b=this.bodyA,H=this.bodyB,st=s,V=r,k=l,M=o,B=u,F=t,T=i,K=n,j=a,pt=c,z=h;this.getWorldAnchorA(F),this.getWorldAnchorB(T),F.vsub(b.position,K),T.vsub(H.position,j),T.vsub(F,st);var A=st.norm();V.copy(st),V.normalize(),H.velocity.vsub(b.velocity,k),H.angularVelocity.cross(j,B),k.vadd(B,k),b.angularVelocity.cross(K,B),k.vsub(B,k),V.mult(-d*(A-f)-x*k.dot(V),M),b.force.vsub(M,b.force),H.force.vadd(M,H.force),K.cross(M,pt),j.cross(M,z),b.torque.vsub(pt,b.torque),H.torque.vadd(z,H.torque)}},{"../math/Vec3":30}],36:[function(v,N,at){var p=v("../math/Vec3"),e=v("../math/Transform"),s=v("../collision/RaycastResult"),r=v("../utils/Utils");N.exports=l;function l(i){i=r.defaults(i,{chassisConnectionPointLocal:new p,chassisConnectionPointWorld:new p,directionLocal:new p,directionWorld:new p,axleLocal:new p,axleWorld:new p,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=i.maxSuspensionTravel,this.customSlidingRotationalSpeed=i.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=i.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=i.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=i.chassisConnectionPointWorld.clone(),this.directionLocal=i.directionLocal.clone(),this.directionWorld=i.directionWorld.clone(),this.axleLocal=i.axleLocal.clone(),this.axleWorld=i.axleWorld.clone(),this.suspensionRestLength=i.suspensionRestLength,this.suspensionMaxLength=i.suspensionMaxLength,this.radius=i.radius,this.suspensionStiffness=i.suspensionStiffness,this.dampingCompression=i.dampingCompression,this.dampingRelaxation=i.dampingRelaxation,this.frictionSlip=i.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=i.rollInfluence,this.maxSuspensionForce=i.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=i.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new s,this.worldTransform=new e,this.isInContact=!1}var t=new p,o=new p,t=new p;l.prototype.updateWheel=function(i){var n=this.raycastResult;if(this.isInContact){var a=n.hitNormalWorld.dot(n.directionWorld);n.hitPointWorld.vsub(i.position,o),i.getVelocityAtWorldPoint(o,t);var c=n.hitNormalWorld.dot(t);if(a>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=1/.1;else{var h=-1/a;this.suspensionRelativeVelocity=c*h,this.clippedInvContactDotSuspension=h}}else n.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,n.directionWorld.scale(-1,n.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(v,N,at){N.exports=r;var p=v("./Shape"),e=v("../math/Vec3"),s=v("./ConvexPolyhedron");function r(t){p.call(this),this.type=p.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}r.prototype=new p,r.prototype.constructor=r,r.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,i=this.halfExtents.y,n=this.halfExtents.z,a=e,c=[new a(-t,-i,-n),new a(t,-i,-n),new a(t,i,-n),new a(-t,i,-n),new a(-t,-i,n),new a(t,-i,n),new a(t,i,n),new a(-t,i,n)],h=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];new a(0,0,1),new a(0,1,0),new a(1,0,0);var u=new s(c,h);this.convexPolyhedronRepresentation=u,u.material=this.material},r.prototype.calculateLocalInertia=function(t,i){return i=i||new e,r.calculateInertia(this.halfExtents,t,i),i},r.calculateInertia=function(t,i,n){var a=t;n.x=1/12*i*(2*a.y*2*a.y+2*a.z*2*a.z),n.y=1/12*i*(2*a.x*2*a.x+2*a.z*2*a.z),n.z=1/12*i*(2*a.y*2*a.y+2*a.x*2*a.x)},r.prototype.getSideNormals=function(t,i){var n=t,a=this.halfExtents;if(n[0].set(a.x,0,0),n[1].set(0,a.y,0),n[2].set(0,0,a.z),n[3].set(-a.x,0,0),n[4].set(0,-a.y,0),n[5].set(0,0,-a.z),i!==void 0)for(var c=0;c!==n.length;c++)i.vmult(n[c],n[c]);return n},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new e;new e,r.prototype.forEachWorldCorner=function(t,i,n){for(var a=this.halfExtents,c=[[a.x,a.y,a.z],[-a.x,a.y,a.z],[-a.x,-a.y,a.z],[-a.x,-a.y,-a.z],[a.x,-a.y,-a.z],[a.x,a.y,-a.z],[-a.x,a.y,-a.z],[a.x,-a.y,a.z]],h=0;h<c.length;h++)l.set(c[h][0],c[h][1],c[h][2]),i.vmult(l,l),t.vadd(l,l),n(l.x,l.y,l.z)};var o=[new e,new e,new e,new e,new e,new e,new e,new e];r.prototype.calculateWorldAABB=function(t,i,n,a){var c=this.halfExtents;o[0].set(c.x,c.y,c.z),o[1].set(-c.x,c.y,c.z),o[2].set(-c.x,-c.y,c.z),o[3].set(-c.x,-c.y,-c.z),o[4].set(c.x,-c.y,-c.z),o[5].set(c.x,c.y,-c.z),o[6].set(-c.x,c.y,-c.z),o[7].set(c.x,-c.y,c.z);var h=o[0];i.vmult(h,h),t.vadd(h,h),a.copy(h),n.copy(h);for(var u=1;u<8;u++){var h=o[u];i.vmult(h,h),t.vadd(h,h);var d=h.x,x=h.y,f=h.z;d>a.x&&(a.x=d),x>a.y&&(a.y=x),f>a.z&&(a.z=f),d<n.x&&(n.x=d),x<n.y&&(n.y=x),f<n.z&&(n.z=f)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(v,N,at){N.exports=r;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("../math/Transform");function r(g,R,w){p.call(this),this.type=p.types.CONVEXPOLYHEDRON,this.vertices=g||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=R||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=w?w.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}r.prototype=new p,r.prototype.constructor=r;var l=new e;r.prototype.computeEdges=function(){var g=this.faces,R=this.vertices;R.length;var w=this.uniqueEdges;w.length=0;for(var m=l,y=0;y!==g.length;y++)for(var C=g[y],G=C.length,W=0;W!==G;W++){var E=(W+1)%G;R[C[W]].vsub(R[C[E]],m),m.normalize();for(var L=!1,X=0;X!==w.length;X++)if(w[X].almostEquals(m)||w[X].almostEquals(m)){L=!0;break}L||w.push(m.clone())}},r.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var g=0;g<this.faces.length;g++){for(var R=0;R<this.faces[g].length;R++)if(!this.vertices[this.faces[g][R]])throw new Error("Vertex "+this.faces[g][R]+" not found!");var w=this.faceNormals[g]||new e;this.getFaceNormal(g,w),w.negate(w),this.faceNormals[g]=w;var m=this.vertices[this.faces[g][0]];if(w.dot(m)<0){console.error(".faceNormals["+g+"] = Vec3("+w.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var R=0;R<this.faces[g].length;R++)console.warn(".vertices["+this.faces[g][R]+"] = Vec3("+this.vertices[this.faces[g][R]].toString()+")")}}};var o=new e,t=new e;r.computeNormal=function(g,R,w,m){R.vsub(g,t),w.vsub(R,o),o.cross(t,m),m.isZero()||m.normalize()},r.prototype.getFaceNormal=function(g,R){var w=this.faces[g],m=this.vertices[w[0]],y=this.vertices[w[1]],C=this.vertices[w[2]];return r.computeNormal(m,y,C,R)};var i=new e;r.prototype.clipAgainstHull=function(g,R,w,m,y,C,G,W,E){for(var L=i,X=-1,ut=-Number.MAX_VALUE,lt=0;lt<w.faces.length;lt++){L.copy(w.faceNormals[lt]),y.vmult(L,L);var nt=L.dot(C);nt>ut&&(ut=nt,X=lt)}for(var O=[],Q=w.faces[X],bt=Q.length,ft=0;ft<bt;ft++){var zt=w.vertices[Q[ft]],ct=new e;ct.copy(zt),y.vmult(ct,ct),m.vadd(ct,ct),O.push(ct)}X>=0&&this.clipFaceAgainstHull(C,g,R,O,G,W,E)};var n=new e,a=new e,c=new e,h=new e,u=new e,d=new e;r.prototype.findSeparatingAxis=function(g,R,w,m,y,C,G,W){var E=n,L=a,X=c,ut=h,lt=u,nt=d,O=Number.MAX_VALUE,Q=this;if(Q.uniqueAxes)for(var ft=0;ft!==Q.uniqueAxes.length;ft++){w.vmult(Q.uniqueAxes[ft],E);var ct=Q.testSepAxis(E,g,R,w,m,y);if(ct===!1)return!1;ct<O&&(O=ct,C.copy(E))}else for(var bt=G?G.length:Q.faces.length,ft=0;ft<bt;ft++){var zt=G?G[ft]:ft;E.copy(Q.faceNormals[zt]),w.vmult(E,E);var ct=Q.testSepAxis(E,g,R,w,m,y);if(ct===!1)return!1;ct<O&&(O=ct,C.copy(E))}if(g.uniqueAxes)for(var ft=0;ft!==g.uniqueAxes.length;ft++){y.vmult(g.uniqueAxes[ft],L);var ct=Q.testSepAxis(L,g,R,w,m,y);if(ct===!1)return!1;ct<O&&(O=ct,C.copy(L))}else for(var St=W?W.length:g.faces.length,ft=0;ft<St;ft++){var zt=W?W[ft]:ft;L.copy(g.faceNormals[zt]),y.vmult(L,L);var ct=Q.testSepAxis(L,g,R,w,m,y);if(ct===!1)return!1;ct<O&&(O=ct,C.copy(L))}for(var Rt=0;Rt!==Q.uniqueEdges.length;Rt++){w.vmult(Q.uniqueEdges[Rt],ut);for(var Mt=0;Mt!==g.uniqueEdges.length;Mt++)if(y.vmult(g.uniqueEdges[Mt],lt),ut.cross(lt,nt),!nt.almostZero()){nt.normalize();var Vt=Q.testSepAxis(nt,g,R,w,m,y);if(Vt===!1)return!1;Vt<O&&(O=Vt,C.copy(nt))}}return m.vsub(R,X),X.dot(C)>0&&C.negate(C),!0};var x=[],f=[];r.prototype.testSepAxis=function(g,R,w,m,y,C){var G=this;r.project(G,g,w,m,x),r.project(R,g,y,C,f);var W=x[0],E=x[1],L=f[0],X=f[1],ut=W-X,lt=L-E,nt=ut<lt?ut:lt;return nt};var b=new e,H=new e;r.prototype.calculateLocalInertia=function(g,R){this.computeLocalAABB(b,H);var w=H.x-b.x,m=H.y-b.y,y=H.z-b.z;R.x=1/12*g*(2*m*2*m+2*y*2*y),R.y=1/12*g*(2*w*2*w+2*y*2*y),R.z=1/12*g*(2*m*2*m+2*w*2*w)},r.prototype.getPlaneConstantOfFace=function(g){var R=this.faces[g],w=this.faceNormals[g],m=this.vertices[R[0]],y=-w.dot(m);return y};var st=new e,V=new e,k=new e,M=new e,B=new e,F=new e,T=new e,K=new e;r.prototype.clipFaceAgainstHull=function(g,R,w,m,y,C,G){for(var W=st,E=V,L=k,X=M,ut=B,lt=F,nt=T,O=K,Q=this,bt=[],ft=m,zt=bt,ct=-1,St=Number.MAX_VALUE,Rt=0;Rt<Q.faces.length;Rt++){W.copy(Q.faceNormals[Rt]),w.vmult(W,W);var Mt=W.dot(g);Mt<St&&(St=Mt,ct=Rt)}if(!(ct<0)){var Vt=Q.faces[ct];Vt.connectedFaces=[];for(var At=0;At<Q.faces.length;At++)for(var Tt=0;Tt<Q.faces[At].length;Tt++)Vt.indexOf(Q.faces[At][Tt])!==-1&&At!==ct&&Vt.connectedFaces.indexOf(At)===-1&&Vt.connectedFaces.push(At);ft.length;for(var Et=Vt.length,Lt=0;Lt<Et;Lt++){var Ut=Q.vertices[Vt[Lt]],le=Q.vertices[Vt[(Lt+1)%Et]];Ut.vsub(le,E),L.copy(E),w.vmult(L,L),R.vadd(L,L),X.copy(this.faceNormals[ct]),w.vmult(X,X),R.vadd(X,X),L.cross(X,ut),ut.negate(ut),lt.copy(Ut),w.vmult(lt,lt),R.vadd(lt,lt),-lt.dot(ut);var Zt;{var fe=Vt.connectedFaces[Lt];nt.copy(this.faceNormals[fe]);var he=this.getPlaneConstantOfFace(fe);O.copy(nt),w.vmult(O,O);var Zt=he-O.dot(R)}for(this.clipFaceAgainstPlane(ft,zt,O,Zt);ft.length;)ft.shift();for(;zt.length;)ft.push(zt.shift())}nt.copy(this.faceNormals[ct]);var he=this.getPlaneConstantOfFace(ct);O.copy(nt),w.vmult(O,O);for(var Zt=he-O.dot(R),At=0;At<ft.length;At++){var jt=O.dot(ft[At])+Zt;if(jt<=y&&(console.log("clamped: depth="+jt+" to minDist="+(y+"")),jt=y),jt<=C){var we=ft[At];if(jt<=0){var ye={point:we,normal:O,depth:jt};G.push(ye)}}}}},r.prototype.clipFaceAgainstPlane=function(g,R,w,m){var y,C,G=g.length;if(G<2)return R;var W=g[g.length-1],E=g[0];y=w.dot(W)+m;for(var L=0;L<G;L++){if(E=g[L],C=w.dot(E)+m,y<0)if(C<0){var X=new e;X.copy(E),R.push(X)}else{var X=new e;W.lerp(E,y/(y-C),X),R.push(X)}else if(C<0){var X=new e;W.lerp(E,y/(y-C),X),R.push(X),R.push(E)}W=E,y=C}return R},r.prototype.computeWorldVertices=function(g,R){for(var w=this.vertices.length;this.worldVertices.length<w;)this.worldVertices.push(new e);for(var m=this.vertices,y=this.worldVertices,C=0;C!==w;C++)R.vmult(m[C],y[C]),g.vadd(y[C],y[C]);this.worldVerticesNeedsUpdate=!1},new e,r.prototype.computeLocalAABB=function(g,R){var w=this.vertices.length,m=this.vertices;g.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),R.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var y=0;y<w;y++){var C=m[y];C.x<g.x?g.x=C.x:C.x>R.x&&(R.x=C.x),C.y<g.y?g.y=C.y:C.y>R.y&&(R.y=C.y),C.z<g.z?g.z=C.z:C.z>R.z&&(R.z=C.z)}},r.prototype.computeWorldFaceNormals=function(g){for(var R=this.faceNormals.length;this.worldFaceNormals.length<R;)this.worldFaceNormals.push(new e);for(var w=this.faceNormals,m=this.worldFaceNormals,y=0;y!==R;y++)g.vmult(w[y],m[y]);this.worldFaceNormalsNeedsUpdate=!1},r.prototype.updateBoundingSphereRadius=function(){for(var g=0,R=this.vertices,w=0,m=R.length;w!==m;w++){var y=R[w].norm2();y>g&&(g=y)}this.boundingSphereRadius=Math.sqrt(g)};var j=new e;r.prototype.calculateWorldAABB=function(g,R,w,m){for(var y=this.vertices.length,C=this.vertices,G,W,E,L,X,ut,lt=0;lt<y;lt++){j.copy(C[lt]),R.vmult(j,j),g.vadd(j,j);var nt=j;nt.x<G||G===void 0?G=nt.x:(nt.x>L||L===void 0)&&(L=nt.x),nt.y<W||W===void 0?W=nt.y:(nt.y>X||X===void 0)&&(X=nt.y),nt.z<E||E===void 0?E=nt.z:(nt.z>ut||ut===void 0)&&(ut=nt.z)}w.set(G,W,E),m.set(L,X,ut)},r.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},r.prototype.getAveragePointLocal=function(g){g=g||new e;for(var R=this.vertices.length,w=this.vertices,m=0;m<R;m++)g.vadd(w[m],g);return g.mult(1/R,g),g},r.prototype.transformAllPoints=function(g,R){var w=this.vertices.length,m=this.vertices;if(R){for(var y=0;y<w;y++){var C=m[y];R.vmult(C,C)}for(var y=0;y<this.faceNormals.length;y++){var C=this.faceNormals[y];R.vmult(C,C)}}if(g)for(var y=0;y<w;y++){var C=m[y];C.vadd(g,C)}};var pt=new e,z=new e,A=new e;r.prototype.pointIsInside=function(g){var R=this.vertices.length,w=this.vertices,m=this.faces,y=this.faceNormals,C=null,G=this.faces.length,W=pt;this.getAveragePointLocal(W);for(var E=0;E<G;E++){this.faces[E].length;var R=y[E],L=w[m[E][0]],X=z;g.vsub(L,X);var ut=R.dot(X),lt=A;W.vsub(L,lt);var nt=R.dot(lt);if(ut<0&&nt>0||ut>0&&nt<0)return!1}return C?1:-1},new e;var _=new e,q=new e;r.project=function(g,R,w,m,y){var C=g.vertices.length,G=_,W=0,E=0,L=q,X=g.vertices;L.setZero(),s.vectorToLocalFrame(w,m,R,G),s.pointToLocalFrame(w,m,L,L);var ut=L.dot(G);E=W=X[0].dot(G);for(var lt=1;lt<C;lt++){var nt=X[lt].dot(G);nt>W&&(W=nt),nt<E&&(E=nt)}if(E-=ut,W-=ut,E>W){var O=E;E=W,W=O}y[0]=W,y[1]=E}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(v,N,at){N.exports=r;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("./ConvexPolyhedron");function r(l,o,t,i){var n=i,a=[],c=[],h=[],u=[],d=[],x=Math.cos,f=Math.sin;a.push(new e(o*x(0),o*f(0),-t*.5)),u.push(0),a.push(new e(l*x(0),l*f(0),t*.5)),d.push(1);for(var b=0;b<n;b++){var H=2*Math.PI/n*(b+1),st=2*Math.PI/n*(b+.5);b<n-1?(a.push(new e(o*x(H),o*f(H),-t*.5)),u.push(2*b+2),a.push(new e(l*x(H),l*f(H),t*.5)),d.push(2*b+3),h.push([2*b+2,2*b+3,2*b+1,2*b])):h.push([0,1,2*b+1,2*b]),(n%2===1||b<n/2)&&c.push(new e(x(st),f(st),0))}h.push(d),c.push(new e(0,0,1));for(var V=[],b=0;b<u.length;b++)V.push(u[u.length-b-1]);h.push(V),this.type=p.types.CONVEXPOLYHEDRON,s.call(this,a,h,c)}r.prototype=new s},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(v,N,at){var p=v("./Shape"),e=v("./ConvexPolyhedron"),s=v("../math/Vec3"),r=v("../utils/Utils");N.exports=l;function l(o,t){t=r.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=o,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,t.minValue===null&&this.updateMinValue(),t.maxValue===null&&this.updateMaxValue(),this.cacheEnabled=!0,p.call(this),this.pillarConvex=new e,this.pillarOffset=new s,this.type=p.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}l.prototype=new p,l.prototype.update=function(){this._cachedPillars={}},l.prototype.updateMinValue=function(){for(var o=this.data,t=o[0][0],i=0;i!==o.length;i++)for(var n=0;n!==o[i].length;n++){var a=o[i][n];a<t&&(t=a)}this.minValue=t},l.prototype.updateMaxValue=function(){for(var o=this.data,t=o[0][0],i=0;i!==o.length;i++)for(var n=0;n!==o[i].length;n++){var a=o[i][n];a>t&&(t=a)}this.maxValue=t},l.prototype.setHeightValueAtIndex=function(o,t,i){var n=this.data;n[o][t]=i,this.clearCachedConvexTrianglePillar(o,t,!1),o>0&&(this.clearCachedConvexTrianglePillar(o-1,t,!0),this.clearCachedConvexTrianglePillar(o-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(o,t-1,!0),this.clearCachedConvexTrianglePillar(o,t-1,!1)),t>0&&o>0&&this.clearCachedConvexTrianglePillar(o-1,t-1,!0)},l.prototype.getRectMinMax=function(o,t,i,n,a){a=a||[];for(var c=this.data,h=this.minValue,u=o;u<=i;u++)for(var d=t;d<=n;d++){var x=c[u][d];x>h&&(h=x)}a[0]=this.minValue,a[1]=h},l.prototype.getIndexOfPosition=function(o,t,i,n){var a=this.elementSize,c=this.data,h=Math.floor(o/a),u=Math.floor(t/a);return i[0]=h,i[1]=u,n&&(h<0&&(h=0),u<0&&(u=0),h>=c.length-1&&(h=c.length-1),u>=c[0].length-1&&(u=c[0].length-1)),!(h<0||u<0||h>=c.length-1||u>=c[0].length-1)},l.prototype.getHeightAt=function(o,t,i){var n=[];this.getIndexOfPosition(o,t,n,i);var a=[];return this.getRectMinMax(n[0],n[1]+1,n[0],n[1]+1,a),(a[0]+a[1])/2},l.prototype.getCacheConvexTrianglePillarKey=function(o,t,i){return o+"_"+t+"_"+(i?1:0)},l.prototype.getCachedConvexTrianglePillar=function(o,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]},l.prototype.setCachedConvexTrianglePillar=function(o,t,i,n,a){this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]={convex:n,offset:a}},l.prototype.clearCachedConvexTrianglePillar=function(o,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(o,t,i)]},l.prototype.getConvexTrianglePillar=function(o,t,i){var n=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){var c=this.getCachedConvexTrianglePillar(o,t,i);if(c){this.pillarConvex=c.convex,this.pillarOffset=c.offset;return}n=new e,a=new s,this.pillarConvex=n,this.pillarOffset=a}var c=this.data,h=this.elementSize,u=n.faces;n.vertices.length=6;for(var d=0;d<6;d++)n.vertices[d]||(n.vertices[d]=new s);u.length=5;for(var d=0;d<5;d++)u[d]||(u[d]=[]);var x=n.vertices,f=(Math.min(c[o][t],c[o+1][t],c[o][t+1],c[o+1][t+1])-this.minValue)/2+this.minValue;i?(a.set((o+.75)*h,(t+.75)*h,f),x[0].set(.25*h,.25*h,c[o+1][t+1]-f),x[1].set(-.75*h,.25*h,c[o][t+1]-f),x[2].set(.25*h,-.75*h,c[o+1][t]-f),x[3].set(.25*h,.25*h,-f-1),x[4].set(-.75*h,.25*h,-f-1),x[5].set(.25*h,-.75*h,-f-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=2,u[2][1]=5,u[2][2]=3,u[2][3]=0,u[3][0]=3,u[3][1]=4,u[3][2]=1,u[3][3]=0,u[4][0]=1,u[4][1]=4,u[4][2]=5,u[4][3]=2):(a.set((o+.25)*h,(t+.25)*h,f),x[0].set(-.25*h,-.25*h,c[o][t]-f),x[1].set(.75*h,-.25*h,c[o+1][t]-f),x[2].set(-.25*h,.75*h,c[o][t+1]-f),x[3].set(-.25*h,-.25*h,-f-1),x[4].set(.75*h,-.25*h,-f-1),x[5].set(-.25*h,.75*h,-f-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=0,u[2][1]=2,u[2][2]=5,u[2][3]=3,u[3][0]=1,u[3][1]=0,u[3][2]=3,u[3][3]=4,u[4][0]=4,u[4][1]=5,u[4][2]=2,u[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(o,t,i,n,a)},l.prototype.calculateLocalInertia=function(o,t){return t=t||new s,t.set(0,0,0),t},l.prototype.volume=function(){return Number.MAX_VALUE},l.prototype.calculateWorldAABB=function(o,t,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},l.prototype.updateBoundingSphereRadius=function(){var o=this.data,t=this.elementSize;this.boundingSphereRadius=new s(o.length*t,o[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(v,N,at){N.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(){p.call(this),this.type=p.types.PARTICLE}s.prototype=new p,s.prototype.constructor=s,s.prototype.calculateLocalInertia=function(r,l){return l=l||new e,l.set(0,0,0),l},s.prototype.volume=function(){return 0},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},s.prototype.calculateWorldAABB=function(r,l,o,t){o.copy(r),t.copy(r)}},{"../math/Vec3":30,"./Shape":43}],42:[function(v,N,at){N.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(){p.call(this),this.type=p.types.PLANE,this.worldNormal=new e,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}s.prototype=new p,s.prototype.constructor=s,s.prototype.computeWorldNormal=function(l){var o=this.worldNormal;o.set(0,0,1),l.vmult(o,o),this.worldNormalNeedsUpdate=!1},s.prototype.calculateLocalInertia=function(l,o){return o=o||new e,o},s.prototype.volume=function(){return Number.MAX_VALUE};var r=new e;s.prototype.calculateWorldAABB=function(l,o,t,i){r.set(0,0,1),o.vmult(r,r);var n=Number.MAX_VALUE;t.set(-n,-n,-n),i.set(n,n,n),r.x===1&&(i.x=l.x),r.y===1&&(i.y=l.y),r.z===1&&(i.z=l.z),r.x===-1&&(t.x=l.x),r.y===-1&&(t.y=l.y),r.z===-1&&(t.z=l.z)},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(v,N,at){N.exports=p;var p=v("./Shape");v("../math/Vec3"),v("../math/Quaternion"),v("../material/Material");function p(){this.id=p.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}p.prototype.constructor=p,p.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},p.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},p.prototype.calculateLocalInertia=function(e,s){throw"calculateLocalInertia() not implemented for shape type "+this.type},p.idCounter=0,p.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(v,N,at){N.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(r){if(p.call(this),this.radius=r!==void 0?Number(r):1,this.type=p.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}s.prototype=new p,s.prototype.constructor=s,s.prototype.calculateLocalInertia=function(r,l){l=l||new e;var o=2*r*this.radius*this.radius/5;return l.x=o,l.y=o,l.z=o,l},s.prototype.volume=function(){return 4*Math.PI*this.radius/3},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},s.prototype.calculateWorldAABB=function(r,l,o,t){for(var i=this.radius,n=["x","y","z"],a=0;a<n.length;a++){var c=n[a];o[c]=r[c]-i,t[c]=r[c]+i}}},{"../math/Vec3":30,"./Shape":43}],45:[function(v,N,at){N.exports=o;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("../math/Transform"),r=v("../collision/AABB"),l=v("../utils/Octree");function o(V,k){p.call(this),this.type=p.types.TRIMESH,this.vertices=new Float32Array(V),this.indices=new Int16Array(k),this.normals=new Float32Array(k.length),this.aabb=new r,this.edges=null,this.scale=new e(1,1,1),this.tree=new l,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}o.prototype=new p,o.prototype.constructor=o;var t=new e;o.prototype.updateTree=function(){var V=this.tree;V.reset(),V.aabb.copy(this.aabb);var k=this.scale;V.aabb.lowerBound.x*=1/k.x,V.aabb.lowerBound.y*=1/k.y,V.aabb.lowerBound.z*=1/k.z,V.aabb.upperBound.x*=1/k.x,V.aabb.upperBound.y*=1/k.y,V.aabb.upperBound.z*=1/k.z;for(var M=new r,B=new e,F=new e,T=new e,K=[B,F,T],j=0;j<this.indices.length/3;j++){var pt=j*3;this._getUnscaledVertex(this.indices[pt],B),this._getUnscaledVertex(this.indices[pt+1],F),this._getUnscaledVertex(this.indices[pt+2],T),M.setFromPoints(K),V.insert(M,j)}V.removeEmptyNodes()};var i=new r;o.prototype.getTrianglesInAABB=function(V,k){i.copy(V);var M=this.scale,B=M.x,F=M.y,T=M.z,K=i.lowerBound,j=i.upperBound;return K.x/=B,K.y/=F,K.z/=T,j.x/=B,j.y/=F,j.z/=T,this.tree.aabbQuery(i,k)},o.prototype.setScale=function(V){var k=this.scale.x===this.scale.y===this.scale.z,M=V.x===V.y===V.z;k&&M||this.updateNormals(),this.scale.copy(V),this.updateAABB(),this.updateBoundingSphereRadius()},o.prototype.updateNormals=function(){for(var V=t,k=this.normals,M=0;M<this.indices.length/3;M++){var B=M*3,F=this.indices[B],T=this.indices[B+1],K=this.indices[B+2];this.getVertex(F,u),this.getVertex(T,d),this.getVertex(K,x),o.computeNormal(d,u,x,V),k[B]=V.x,k[B+1]=V.y,k[B+2]=V.z}},o.prototype.updateEdges=function(){for(var V={},k=function(pt,z){var A=F<T?F+"_"+T:T+"_"+F;V[A]=!0},M=0;M<this.indices.length/3;M++){var B=M*3,F=this.indices[B],T=this.indices[B+1];this.indices[B+2],k(),k(),k()}var K=Object.keys(V);this.edges=new Int16Array(K.length*2);for(var M=0;M<K.length;M++){var j=K[M].split("_");this.edges[2*M]=parseInt(j[0],10),this.edges[2*M+1]=parseInt(j[1],10)}},o.prototype.getEdgeVertex=function(V,k,M){var B=this.edges[V*2+(k?1:0)];this.getVertex(B,M)};var n=new e,a=new e;o.prototype.getEdgeVector=function(V,k){var M=n,B=a;this.getEdgeVertex(V,0,M),this.getEdgeVertex(V,1,B),B.vsub(M,k)};var c=new e,h=new e;o.computeNormal=function(V,k,M,B){k.vsub(V,h),M.vsub(k,c),c.cross(h,B),B.isZero()||B.normalize()};var u=new e,d=new e,x=new e;o.prototype.getVertex=function(V,k){var M=this.scale;return this._getUnscaledVertex(V,k),k.x*=M.x,k.y*=M.y,k.z*=M.z,k},o.prototype._getUnscaledVertex=function(V,k){var M=V*3,B=this.vertices;return k.set(B[M],B[M+1],B[M+2])},o.prototype.getWorldVertex=function(V,k,M,B){return this.getVertex(V,B),s.pointToWorldFrame(k,M,B,B),B},o.prototype.getTriangleVertices=function(V,k,M,B){var F=V*3;this.getVertex(this.indices[F],k),this.getVertex(this.indices[F+1],M),this.getVertex(this.indices[F+2],B)},o.prototype.getNormal=function(V,k){var M=V*3;return k.set(this.normals[M],this.normals[M+1],this.normals[M+2])};var f=new r;o.prototype.calculateLocalInertia=function(V,k){this.computeLocalAABB(f);var M=f.upperBound.x-f.lowerBound.x,B=f.upperBound.y-f.lowerBound.y,F=f.upperBound.z-f.lowerBound.z;return k.set(1/12*V*(2*B*2*B+2*F*2*F),1/12*V*(2*M*2*M+2*F*2*F),1/12*V*(2*B*2*B+2*M*2*M))};var b=new e;o.prototype.computeLocalAABB=function(V){var k=V.lowerBound,M=V.upperBound,B=this.vertices.length;this.vertices;var F=b;this.getVertex(0,F),k.copy(F),M.copy(F);for(var T=0;T!==B;T++)this.getVertex(T,F),F.x<k.x?k.x=F.x:F.x>M.x&&(M.x=F.x),F.y<k.y?k.y=F.y:F.y>M.y&&(M.y=F.y),F.z<k.z?k.z=F.z:F.z>M.z&&(M.z=F.z)},o.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},o.prototype.updateBoundingSphereRadius=function(){for(var V=0,k=this.vertices,M=new e,B=0,F=k.length/3;B!==F;B++){this.getVertex(B,M);var T=M.norm2();T>V&&(V=T)}this.boundingSphereRadius=Math.sqrt(V)},new e;var H=new s,st=new r;o.prototype.calculateWorldAABB=function(V,k,M,B){var F=H,T=st;F.position=V,F.quaternion=k,this.aabb.toWorldFrame(F,T),M.copy(T.lowerBound),B.copy(T.upperBound)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.createTorus=function(V,k,M,B,F){V=V||1,k=k||.5,M=M||8,B=B||6,F=F||Math.PI*2;for(var T=[],K=[],j=0;j<=M;j++)for(var pt=0;pt<=B;pt++){var z=pt/B*F,A=j/M*Math.PI*2,_=(V+k*Math.cos(A))*Math.cos(z),q=(V+k*Math.cos(A))*Math.sin(z),g=k*Math.sin(A);T.push(_,q,g)}for(var j=1;j<=M;j++)for(var pt=1;pt<=B;pt++){var R=(B+1)*j+pt-1,w=(B+1)*(j-1)+pt-1,m=(B+1)*(j-1)+pt,y=(B+1)*j+pt;K.push(R,w,y),K.push(w,m,y)}return new o(T,K)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(v,N,at){N.exports=e,v("../math/Vec3"),v("../math/Quaternion");var p=v("./Solver");function e(){p.call(this),this.iterations=10,this.tolerance=1e-7}e.prototype=new p;var s=[],r=[],l=[];e.prototype.solve=function(o,t){var i=0,n=this.iterations,a=this.tolerance*this.tolerance,c=this.equations,h=c.length,u=t.bodies,d=u.length,x=o,f,b,H,st,V,k;if(h!==0)for(var M=0;M!==d;M++)u[M].updateSolveMassProperties();var B=r,F=l,T=s;B.length=h,F.length=h,T.length=h;for(var M=0;M!==h;M++){var K=c[M];T[M]=0,F[M]=K.computeB(x),B[M]=1/K.computeC()}if(h!==0){for(var M=0;M!==d;M++){var j=u[M],pt=j.vlambda,z=j.wlambda;pt.set(0,0,0),z&&z.set(0,0,0)}for(i=0;i!==n;i++){st=0;for(var A=0;A!==h;A++){var K=c[A];f=F[A],b=B[A],k=T[A],V=K.computeGWlambda(),H=b*(f-V-K.eps*k),k+H<K.minForce?H=K.minForce-k:k+H>K.maxForce&&(H=K.maxForce-k),T[A]+=H,st+=H>0?H:-H,K.addToWlambda(H)}if(st*st<a)break}for(var M=0;M!==d;M++){var j=u[M],_=j.velocity,q=j.angularVelocity;_.vadd(j.vlambda,_),q&&q.vadd(j.wlambda,q)}}return i}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(v,N,at){N.exports=p;function p(){this.equations=[]}p.prototype.solve=function(e,s){return 0},p.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},p.prototype.removeEquation=function(e){var s=this.equations,r=s.indexOf(e);r!==-1&&s.splice(r,1)},p.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(v,N,at){N.exports=s,v("../math/Vec3"),v("../math/Quaternion");var p=v("./Solver"),e=v("../objects/Body");function s(u){for(p.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=u,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}s.prototype=new p;var r=[],l=[],o={bodies:[]},t=e.STATIC;function i(u){for(var d=u.length,x=0;x!==d;x++){var f=u[x];if(!f.visited&&!(f.body.type&t))return f}return!1}var n=[];function a(u,d,x,f){for(n.push(u),u.visited=!0,d(u,x,f);n.length;)for(var b=n.pop(),H;H=i(b.children);)H.visited=!0,d(H,x,f),n.push(H)}function c(u,d,x){d.push(u.body);for(var f=u.eqs.length,b=0;b!==f;b++){var H=u.eqs[b];x.indexOf(H)===-1&&x.push(H)}}s.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},s.prototype.solve=function(u,d){for(var x=r,f=this.nodePool,b=d.bodies,H=this.equations,st=H.length,V=b.length,k=this.subsolver;f.length<V;)f.push(this.createNode());x.length=V;for(var M=0;M<V;M++)x[M]=f[M];for(var M=0;M!==V;M++){var B=x[M];B.body=b[M],B.children.length=0,B.eqs.length=0,B.visited=!1}for(var F=0;F!==st;F++){var T=H[F],M=b.indexOf(T.bi),K=b.indexOf(T.bj),j=x[M],pt=x[K];j.children.push(pt),j.eqs.push(T),pt.children.push(j),pt.eqs.push(T)}var z,A=0,_=l;k.tolerance=this.tolerance,k.iterations=this.iterations;for(var q=o;z=i(x);){_.length=0,q.bodies.length=0,a(z,c,q.bodies,_);var g=_.length;_=_.sort(h);for(var M=0;M!==g;M++)k.addEquation(_[M]);k.solve(u,q),k.removeAllEquations(),A++}return A};function h(u,d){return d.id-u.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(v,N,at){var p=function(){};N.exports=p,p.prototype={constructor:p,addEventListener:function(e,s){this._listeners===void 0&&(this._listeners={});var r=this._listeners;return r[e]===void 0&&(r[e]=[]),r[e].indexOf(s)===-1&&r[e].push(s),this},hasEventListener:function(e,s){if(this._listeners===void 0)return!1;var r=this._listeners;return r[e]!==void 0&&r[e].indexOf(s)!==-1},removeEventListener:function(e,s){if(this._listeners===void 0)return this;var r=this._listeners;if(r[e]===void 0)return this;var l=r[e].indexOf(s);return l!==-1&&r[e].splice(l,1),this},dispatchEvent:function(e){if(this._listeners===void 0)return this;var s=this._listeners,r=s[e.type];if(r!==void 0){e.target=this;for(var l=0,o=r.length;l<o;l++)r[l].call(this,e)}return this}}},{}],50:[function(v,N,at){var p=v("../collision/AABB"),e=v("../math/Vec3");N.exports=r;function s(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new p,this.data=[],this.children=[]}function r(t,i){i=i||{},i.root=null,i.aabb=t,s.call(this,i),this.maxDepth=typeof i.maxDepth<"u"?i.maxDepth:8}r.prototype=new s,s.prototype.reset=function(t,i){this.children.length=this.data.length=0},s.prototype.insert=function(t,i,n){var a=this.data;if(n=n||0,!this.aabb.contains(t))return!1;var c=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var h=!1;c.length||(this.subdivide(),h=!0);for(var u=0;u!==8;u++)if(c[u].insert(t,i,n+1))return!0;h&&(c.length=0)}return a.push(i),!0};var l=new e;s.prototype.subdivide=function(){var t=this.aabb,i=t.lowerBound,n=t.upperBound,a=this.children;a.push(new s({aabb:new p({lowerBound:new e(0,0,0)})}),new s({aabb:new p({lowerBound:new e(1,0,0)})}),new s({aabb:new p({lowerBound:new e(1,1,0)})}),new s({aabb:new p({lowerBound:new e(1,1,1)})}),new s({aabb:new p({lowerBound:new e(0,1,1)})}),new s({aabb:new p({lowerBound:new e(0,0,1)})}),new s({aabb:new p({lowerBound:new e(1,0,1)})}),new s({aabb:new p({lowerBound:new e(0,1,0)})})),n.vsub(i,l),l.scale(.5,l);for(var c=this.root||this,h=0;h!==8;h++){var u=a[h];u.root=c;var d=u.aabb.lowerBound;d.x*=l.x,d.y*=l.y,d.z*=l.z,d.vadd(i,d),d.vadd(l,u.aabb.upperBound)}},s.prototype.aabbQuery=function(t,i){this.data,this.children;for(var n=[this];n.length;){var a=n.pop();a.aabb.overlaps(t)&&Array.prototype.push.apply(i,a.data),Array.prototype.push.apply(n,a.children)}return i};var o=new p;s.prototype.rayQuery=function(t,i,n){return t.getAABB(o),o.toLocalFrame(i,o),this.aabbQuery(o,n),n},s.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var i=t.pop(),n=i.children.length-1;n>=0;n--)i.children[n].data.length||i.children.splice(n,1);Array.prototype.push.apply(t,i.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(v,N,at){N.exports=p;function p(){this.objects=[],this.type=Object}p.prototype.release=function(){for(var e=arguments.length,s=0;s!==e;s++)this.objects.push(arguments[s])},p.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},p.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(v,N,at){N.exports=p;function p(){this.data={keys:[]}}p.prototype.get=function(e,s){if(e>s){var r=s;s=e,e=r}return this.data[e+"-"+s]},p.prototype.set=function(e,s,r){if(e>s){var l=s;s=e,e=l}var o=e+"-"+s;this.get(e,s)||this.data.keys.push(o),this.data[o]=r},p.prototype.reset=function(){for(var e=this.data,s=e.keys;s.length>0;){var r=s.pop();delete e[r]}}},{}],53:[function(v,N,at){function p(){}N.exports=p,p.defaults=function(e,s){e=e||{};for(var r in s)r in e||(e[r]=s[r]);return e}},{}],54:[function(v,N,at){N.exports=s;var p=v("../math/Vec3"),e=v("./Pool");function s(){e.call(this),this.type=p}s.prototype=new e,s.prototype.constructObject=function(){return new p}},{"../math/Vec3":30,"./Pool":51}],55:[function(v,N,at){N.exports=a;var p=v("../collision/AABB"),e=v("../shapes/Shape"),s=v("../collision/Ray"),r=v("../math/Vec3"),l=v("../math/Transform");v("../shapes/ConvexPolyhedron");var o=v("../math/Quaternion");v("../solver/Solver");var t=v("../utils/Vec3Pool"),i=v("../equations/ContactEquation"),n=v("../equations/FrictionEquation");function a(P){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new t,this.world=P,this.currentContactMaterial=null,this.enableFrictionReduction=!1}a.prototype.createContactEquation=function(P,I,U,D,yt,rt){var J;this.contactPointPool.length?(J=this.contactPointPool.pop(),J.bi=P,J.bj=I):J=new i(P,I),J.enabled=P.collisionResponse&&I.collisionResponse&&U.collisionResponse&&D.collisionResponse;var ot=this.currentContactMaterial;J.restitution=ot.restitution,J.setSpookParams(ot.contactEquationStiffness,ot.contactEquationRelaxation,this.world.dt);var S=U.material||P.material,$=D.material||I.material;return S&&$&&S.restitution>=0&&$.restitution>=0&&(J.restitution=S.restitution*$.restitution),J.si=yt||U,J.sj=rt||D,J},a.prototype.createFrictionEquationsFromContact=function(P,I){var U=P.bi,D=P.bj,yt=P.si,rt=P.sj,J=this.world,ot=this.currentContactMaterial,S=ot.friction,$=yt.material||U.material,it=rt.material||D.material;if($&&it&&$.friction>=0&&it.friction>=0&&(S=$.friction*it.friction),S>0){var ht=S*J.gravity.length(),tt=U.invMass+D.invMass;tt>0&&(tt=1/tt);var Z=this.frictionEquationPool,et=Z.length?Z.pop():new n(U,D,ht*tt),vt=Z.length?Z.pop():new n(U,D,ht*tt);return et.bi=vt.bi=U,et.bj=vt.bj=D,et.minForce=vt.minForce=-ht*tt,et.maxForce=vt.maxForce=ht*tt,et.ri.copy(P.ri),et.rj.copy(P.rj),vt.ri.copy(P.ri),vt.rj.copy(P.rj),P.ni.tangents(et.t,vt.t),et.setSpookParams(ot.frictionEquationStiffness,ot.frictionEquationRelaxation,J.dt),vt.setSpookParams(ot.frictionEquationStiffness,ot.frictionEquationRelaxation,J.dt),et.enabled=vt.enabled=P.enabled,I.push(et,vt),!0}return!1};var c=new r,h=new r,u=new r;a.prototype.createFrictionFromAverage=function(P){var I=this.result[this.result.length-1];if(!(!this.createFrictionEquationsFromContact(I,this.frictionResult)||P===1)){var U=this.frictionResult[this.frictionResult.length-2],D=this.frictionResult[this.frictionResult.length-1];c.setZero(),h.setZero(),u.setZero();var yt=I.bi;I.bj;for(var rt=0;rt!==P;rt++)I=this.result[this.result.length-1-rt],I.bodyA!==yt?(c.vadd(I.ni,c),h.vadd(I.ri,h),u.vadd(I.rj,u)):(c.vsub(I.ni,c),h.vadd(I.rj,h),u.vadd(I.ri,u));var J=1/P;h.scale(J,U.ri),u.scale(J,U.rj),D.ri.copy(U.ri),D.rj.copy(U.rj),c.normalize(),c.tangents(U.t,D.t)}};var d=new r,x=new r,f=new o,b=new o;a.prototype.getContacts=function(P,I,U,D,yt,rt,J){this.contactPointPool=yt,this.frictionEquationPool=J,this.result=D,this.frictionResult=rt;for(var ot=f,S=b,$=d,it=x,ht=0,tt=P.length;ht!==tt;ht++){var Z=P[ht],et=I[ht],vt=null;Z.material&&et.material&&(vt=U.getContactMaterial(Z.material,et.material)||null);for(var wt=0;wt<Z.shapes.length;wt++){Z.quaternion.mult(Z.shapeOrientations[wt],ot),Z.quaternion.vmult(Z.shapeOffsets[wt],$),$.vadd(Z.position,$);for(var Y=Z.shapes[wt],xt=0;xt<et.shapes.length;xt++){et.quaternion.mult(et.shapeOrientations[xt],S),et.quaternion.vmult(et.shapeOffsets[xt],it),it.vadd(et.position,it);var gt=et.shapes[xt];if(!($.distanceTo(it)>Y.boundingSphereRadius+gt.boundingSphereRadius)){var Wt=null;Y.material&&gt.material&&(Wt=U.getContactMaterial(Y.material,gt.material)||null),this.currentContactMaterial=Wt||vt||U.defaultContactMaterial;var Bt=this[Y.type|gt.type];Bt&&(Y.type<gt.type?Bt.call(this,Y,gt,$,it,ot,S,Z,et,Y,gt):Bt.call(this,gt,Y,it,$,S,ot,et,Z,Y,gt))}}}}},a.prototype[e.types.BOX|e.types.BOX]=a.prototype.boxBox=function(P,I,U,D,yt,rt,J,ot){P.convexPolyhedronRepresentation.material=P.material,I.convexPolyhedronRepresentation.material=I.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,I.convexPolyhedronRepresentation.collisionResponse=I.collisionResponse,this.convexConvex(P.convexPolyhedronRepresentation,I.convexPolyhedronRepresentation,U,D,yt,rt,J,ot,P,I)},a.prototype[e.types.BOX|e.types.CONVEXPOLYHEDRON]=a.prototype.boxConvex=function(P,I,U,D,yt,rt,J,ot){P.convexPolyhedronRepresentation.material=P.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,this.convexConvex(P.convexPolyhedronRepresentation,I,U,D,yt,rt,J,ot,P,I)},a.prototype[e.types.BOX|e.types.PARTICLE]=a.prototype.boxParticle=function(P,I,U,D,yt,rt,J,ot){P.convexPolyhedronRepresentation.material=P.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,this.convexParticle(P.convexPolyhedronRepresentation,I,U,D,yt,rt,J,ot,P,I)},a.prototype[e.types.SPHERE]=a.prototype.sphereSphere=function(P,I,U,D,yt,rt,J,ot){var S=this.createContactEquation(J,ot,P,I);D.vsub(U,S.ni),S.ni.normalize(),S.ri.copy(S.ni),S.rj.copy(S.ni),S.ri.mult(P.radius,S.ri),S.rj.mult(-I.radius,S.rj),S.ri.vadd(U,S.ri),S.ri.vsub(J.position,S.ri),S.rj.vadd(D,S.rj),S.rj.vsub(ot.position,S.rj),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)};var H=new r,st=new r,V=new r;a.prototype[e.types.PLANE|e.types.TRIMESH]=a.prototype.planeTrimesh=function(P,I,U,D,yt,rt,J,ot){var S=new r,$=H;$.set(0,0,1),yt.vmult($,$);for(var it=0;it<I.vertices.length/3;it++){I.getVertex(it,S);var ht=new r;ht.copy(S),l.pointToWorldFrame(D,rt,ht,S);var tt=st;S.vsub(U,tt);var Z=$.dot(tt);if(Z<=0){var et=this.createContactEquation(J,ot,P,I);et.ni.copy($);var vt=V;$.scale(tt.dot($),vt),S.vsub(vt,vt),et.ri.copy(vt),et.ri.vsub(J.position,et.ri),et.rj.copy(S),et.rj.vsub(ot.position,et.rj),this.result.push(et),this.createFrictionEquationsFromContact(et,this.frictionResult)}}};var k=new r,M=new r;new r;var B=new r,F=new r,T=new r,K=new r,j=new r,pt=new r,z=new r,A=new r,_=new r,q=new r,g=new r,R=new p,w=[];a.prototype[e.types.SPHERE|e.types.TRIMESH]=a.prototype.sphereTrimesh=function(P,I,U,D,yt,rt,J,ot){var S=T,$=K,it=j,ht=pt,tt=z,Z=A,et=R,vt=F,wt=M,Y=w;l.pointToLocalFrame(D,rt,U,tt);var xt=P.radius;et.lowerBound.set(tt.x-xt,tt.y-xt,tt.z-xt),et.upperBound.set(tt.x+xt,tt.y+xt,tt.z+xt),I.getTrianglesInAABB(et,Y);for(var gt=B,Wt=P.radius*P.radius,Bt=0;Bt<Y.length;Bt++)for(var Ct=0;Ct<3;Ct++)if(I.getVertex(I.indices[Y[Bt]*3+Ct],gt),gt.vsub(tt,wt),wt.norm2()<=Wt){vt.copy(gt),l.pointToWorldFrame(D,rt,vt,gt),gt.vsub(U,wt);var dt=this.createContactEquation(J,ot,P,I);dt.ni.copy(wt),dt.ni.normalize(),dt.ri.copy(dt.ni),dt.ri.scale(P.radius,dt.ri),dt.ri.vadd(U,dt.ri),dt.ri.vsub(J.position,dt.ri),dt.rj.copy(gt),dt.rj.vsub(ot.position,dt.rj),this.result.push(dt),this.createFrictionEquationsFromContact(dt,this.frictionResult)}for(var Bt=0;Bt<Y.length;Bt++)for(var Ct=0;Ct<3;Ct++){I.getVertex(I.indices[Y[Bt]*3+Ct],S),I.getVertex(I.indices[Y[Bt]*3+(Ct+1)%3],$),$.vsub(S,it),tt.vsub($,Z);var Kt=Z.dot(it);tt.vsub(S,Z);var Jt=Z.dot(it);if(Jt>0&&Kt<0){tt.vsub(S,Z),ht.copy(it),ht.normalize(),Jt=Z.dot(ht),ht.scale(Jt,Z),Z.vadd(S,Z);var Dt=Z.distanceTo(tt);if(Dt<P.radius){var dt=this.createContactEquation(J,ot,P,I);Z.vsub(tt,dt.ni),dt.ni.normalize(),dt.ni.scale(P.radius,dt.ri),l.pointToWorldFrame(D,rt,Z,Z),Z.vsub(ot.position,dt.rj),l.vectorToWorldFrame(rt,dt.ni,dt.ni),l.vectorToWorldFrame(rt,dt.ri,dt.ri),this.result.push(dt),this.createFrictionEquationsFromContact(dt,this.frictionResult)}}}for(var ce=_,Xt=q,Pt=g,ue=k,Bt=0,Ft=Y.length;Bt!==Ft;Bt++){I.getTriangleVertices(Y[Bt],ce,Xt,Pt),I.getNormal(Y[Bt],ue),tt.vsub(ce,Z);var Dt=Z.dot(ue);if(ue.scale(Dt,Z),tt.vsub(Z,Z),Dt=Z.distanceTo(tt),s.pointInTriangle(Z,ce,Xt,Pt)&&Dt<P.radius){var dt=this.createContactEquation(J,ot,P,I);Z.vsub(tt,dt.ni),dt.ni.normalize(),dt.ni.scale(P.radius,dt.ri),l.pointToWorldFrame(D,rt,Z,Z),Z.vsub(ot.position,dt.rj),l.vectorToWorldFrame(rt,dt.ni,dt.ni),l.vectorToWorldFrame(rt,dt.ri,dt.ri),this.result.push(dt),this.createFrictionEquationsFromContact(dt,this.frictionResult)}}Y.length=0};var m=new r,y=new r;a.prototype[e.types.SPHERE|e.types.PLANE]=a.prototype.spherePlane=function(P,I,U,D,yt,rt,J,ot){var S=this.createContactEquation(J,ot,P,I);if(S.ni.set(0,0,1),rt.vmult(S.ni,S.ni),S.ni.negate(S.ni),S.ni.normalize(),S.ni.mult(P.radius,S.ri),U.vsub(D,m),S.ni.mult(S.ni.dot(m),y),m.vsub(y,S.rj),-m.dot(S.ni)<=P.radius){var $=S.ri,it=S.rj;$.vadd(U,$),$.vsub(J.position,$),it.vadd(D,it),it.vsub(ot.position,it),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}};var C=new r,G=new r,W=new r;function E(P,I,U){for(var D=null,yt=P.length,rt=0;rt!==yt;rt++){var J=P[rt],ot=C;P[(rt+1)%yt].vsub(J,ot);var S=G;ot.cross(I,S);var $=W;U.vsub(J,$);var it=S.dot($);if(D===null||it>0&&D===!0||it<=0&&D===!1){D===null&&(D=it>0);continue}else return!1}return!0}var L=new r,X=new r,ut=new r,lt=new r,nt=[new r,new r,new r,new r,new r,new r],O=new r,Q=new r,bt=new r,ft=new r;a.prototype[e.types.SPHERE|e.types.BOX]=a.prototype.sphereBox=function(P,I,U,D,yt,rt,J,ot){var S=this.v3pool,$=nt;U.vsub(D,L),I.getSideNormals($,rt);for(var it=P.radius,ht=!1,tt=Q,Z=bt,et=ft,vt=null,wt=0,Y=0,xt=0,gt=null,Wt=0,Bt=$.length;Wt!==Bt&&ht===!1;Wt++){var Ct=X;Ct.copy($[Wt]);var dt=Ct.norm();Ct.normalize();var Kt=L.dot(Ct);if(Kt<dt+it&&Kt>0){var Jt=ut,Dt=lt;Jt.copy($[(Wt+1)%3]),Dt.copy($[(Wt+2)%3]);var ce=Jt.norm(),Xt=Dt.norm();Jt.normalize(),Dt.normalize();var Pt=L.dot(Jt),ue=L.dot(Dt);if(Pt<ce&&Pt>-ce&&ue<Xt&&ue>-Xt){var Ot=Math.abs(Kt-dt-it);(gt===null||Ot<gt)&&(gt=Ot,Y=Pt,xt=ue,vt=dt,tt.copy(Ct),Z.copy(Jt),et.copy(Dt),wt++)}}}if(wt){ht=!0;var mt=this.createContactEquation(J,ot,P,I);tt.mult(-it,mt.ri),mt.ni.copy(tt),mt.ni.negate(mt.ni),tt.mult(vt,tt),Z.mult(Y,Z),tt.vadd(Z,tt),et.mult(xt,et),tt.vadd(et,mt.rj),mt.ri.vadd(U,mt.ri),mt.ri.vsub(J.position,mt.ri),mt.rj.vadd(D,mt.rj),mt.rj.vsub(ot.position,mt.rj),this.result.push(mt),this.createFrictionEquationsFromContact(mt,this.frictionResult)}for(var Ft=S.get(),pe=O,Yt=0;Yt!==2&&!ht;Yt++)for(var Gt=0;Gt!==2&&!ht;Gt++)for(var kt=0;kt!==2&&!ht;kt++)if(Ft.set(0,0,0),Yt?Ft.vadd($[0],Ft):Ft.vsub($[0],Ft),Gt?Ft.vadd($[1],Ft):Ft.vsub($[1],Ft),kt?Ft.vadd($[2],Ft):Ft.vsub($[2],Ft),D.vadd(Ft,pe),pe.vsub(U,pe),pe.norm2()<it*it){ht=!0;var mt=this.createContactEquation(J,ot,P,I);mt.ri.copy(pe),mt.ri.normalize(),mt.ni.copy(mt.ri),mt.ri.mult(it,mt.ri),mt.rj.copy(Ft),mt.ri.vadd(U,mt.ri),mt.ri.vsub(J.position,mt.ri),mt.rj.vadd(D,mt.rj),mt.rj.vsub(ot.position,mt.rj),this.result.push(mt),this.createFrictionEquationsFromContact(mt,this.frictionResult)}S.release(Ft),Ft=null;for(var $t=S.get(),ve=S.get(),mt=S.get(),Qt=S.get(),Ot=S.get(),be=$.length,Yt=0;Yt!==be&&!ht;Yt++)for(var Gt=0;Gt!==be&&!ht;Gt++)if(Yt%3!==Gt%3){$[Gt].cross($[Yt],$t),$t.normalize(),$[Yt].vadd($[Gt],ve),mt.copy(U),mt.vsub(ve,mt),mt.vsub(D,mt);var Ae=mt.dot($t);$t.mult(Ae,Qt);for(var kt=0;kt===Yt%3||kt===Gt%3;)kt++;Ot.copy(U),Ot.vsub(Qt,Ot),Ot.vsub(ve,Ot),Ot.vsub(D,Ot);var _e=Math.abs(Ae),Qe=Ot.norm();if(_e<$[kt].norm()&&Qe<it){ht=!0;var Nt=this.createContactEquation(J,ot,P,I);ve.vadd(Qt,Nt.rj),Nt.rj.copy(Nt.rj),Ot.negate(Nt.ni),Nt.ni.normalize(),Nt.ri.copy(Nt.rj),Nt.ri.vadd(D,Nt.ri),Nt.ri.vsub(U,Nt.ri),Nt.ri.normalize(),Nt.ri.mult(it,Nt.ri),Nt.ri.vadd(U,Nt.ri),Nt.ri.vsub(J.position,Nt.ri),Nt.rj.vadd(D,Nt.rj),Nt.rj.vsub(ot.position,Nt.rj),this.result.push(Nt),this.createFrictionEquationsFromContact(Nt,this.frictionResult)}}S.release($t,ve,mt,Qt,Ot)};var zt=new r,ct=new r,St=new r,Rt=new r,Mt=new r,Vt=new r,At=new r,Tt=new r,Et=new r,Lt=new r;a.prototype[e.types.SPHERE|e.types.CONVEXPOLYHEDRON]=a.prototype.sphereConvex=function(P,I,U,D,yt,rt,J,ot){var S=this.v3pool;U.vsub(D,zt);for(var $=I.faceNormals,it=I.faces,ht=I.vertices,tt=P.radius,Z=0;Z!==ht.length;Z++){var et=ht[Z],vt=Mt;rt.vmult(et,vt),D.vadd(vt,vt);var wt=Rt;if(vt.vsub(U,wt),wt.norm2()<tt*tt){xt=!0;var Y=this.createContactEquation(J,ot,P,I);Y.ri.copy(wt),Y.ri.normalize(),Y.ni.copy(Y.ri),Y.ri.mult(tt,Y.ri),vt.vsub(D,Y.rj),Y.ri.vadd(U,Y.ri),Y.ri.vsub(J.position,Y.ri),Y.rj.vadd(D,Y.rj),Y.rj.vsub(ot.position,Y.rj),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);return}}for(var xt=!1,Z=0,gt=it.length;Z!==gt&&xt===!1;Z++){var Wt=$[Z],Bt=it[Z],Ct=Vt;rt.vmult(Wt,Ct);var dt=At;rt.vmult(ht[Bt[0]],dt),dt.vadd(D,dt);var Kt=Tt;Ct.mult(-tt,Kt),U.vadd(Kt,Kt);var Jt=Et;Kt.vsub(dt,Jt);var Dt=Jt.dot(Ct),ce=Lt;if(U.vsub(dt,ce),Dt<0&&ce.dot(Ct)>0){for(var Xt=[],Pt=0,ue=Bt.length;Pt!==ue;Pt++){var Ft=S.get();rt.vmult(ht[Bt[Pt]],Ft),D.vadd(Ft,Ft),Xt.push(Ft)}if(E(Xt,Ct,U)){xt=!0;var Y=this.createContactEquation(J,ot,P,I);Ct.mult(-tt,Y.ri),Ct.negate(Y.ni);var pe=S.get();Ct.mult(-Dt,pe);var Yt=S.get();Ct.mult(-tt,Yt),U.vsub(D,Y.rj),Y.rj.vadd(Yt,Y.rj),Y.rj.vadd(pe,Y.rj),Y.rj.vadd(D,Y.rj),Y.rj.vsub(ot.position,Y.rj),Y.ri.vadd(U,Y.ri),Y.ri.vsub(J.position,Y.ri),S.release(pe),S.release(Yt),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);for(var Pt=0,Gt=Xt.length;Pt!==Gt;Pt++)S.release(Xt[Pt]);return}else for(var Pt=0;Pt!==Bt.length;Pt++){var kt=S.get(),$t=S.get();rt.vmult(ht[Bt[(Pt+1)%Bt.length]],kt),rt.vmult(ht[Bt[(Pt+2)%Bt.length]],$t),D.vadd(kt,kt),D.vadd($t,$t);var ve=ct;$t.vsub(kt,ve);var mt=St;ve.unit(mt);var Qt=S.get(),Ot=S.get();U.vsub(kt,Ot);var be=Ot.dot(mt);mt.mult(be,Qt),Qt.vadd(kt,Qt);var Ae=S.get();if(Qt.vsub(U,Ae),be>0&&be*be<ve.norm2()&&Ae.norm2()<tt*tt){var Y=this.createContactEquation(J,ot,P,I);Qt.vsub(D,Y.rj),Qt.vsub(U,Y.ni),Y.ni.normalize(),Y.ni.mult(tt,Y.ri),Y.rj.vadd(D,Y.rj),Y.rj.vsub(ot.position,Y.rj),Y.ri.vadd(U,Y.ri),Y.ri.vsub(J.position,Y.ri),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult);for(var Pt=0,Gt=Xt.length;Pt!==Gt;Pt++)S.release(Xt[Pt]);S.release(kt),S.release($t),S.release(Qt),S.release(Ae),S.release(Ot);return}S.release(kt),S.release($t),S.release(Qt),S.release(Ae),S.release(Ot)}for(var Pt=0,Gt=Xt.length;Pt!==Gt;Pt++)S.release(Xt[Pt])}}},new r,new r,a.prototype[e.types.PLANE|e.types.BOX]=a.prototype.planeBox=function(P,I,U,D,yt,rt,J,ot){I.convexPolyhedronRepresentation.material=I.material,I.convexPolyhedronRepresentation.collisionResponse=I.collisionResponse,this.planeConvex(P,I.convexPolyhedronRepresentation,U,D,yt,rt,J,ot)};var Ut=new r,le=new r,fe=new r,he=new r;a.prototype[e.types.PLANE|e.types.CONVEXPOLYHEDRON]=a.prototype.planeConvex=function(P,I,U,D,yt,rt,J,ot){var S=Ut,$=le;$.set(0,0,1),yt.vmult($,$);for(var it=0,ht=fe,tt=0;tt!==I.vertices.length;tt++){S.copy(I.vertices[tt]),rt.vmult(S,S),D.vadd(S,S),S.vsub(U,ht);var Z=$.dot(ht);if(Z<=0){var et=this.createContactEquation(J,ot,P,I),vt=he;$.mult($.dot(ht),vt),S.vsub(vt,vt),vt.vsub(U,et.ri),et.ni.copy($),S.vsub(D,et.rj),et.ri.vadd(U,et.ri),et.ri.vsub(J.position,et.ri),et.rj.vadd(D,et.rj),et.rj.vsub(ot.position,et.rj),this.result.push(et),it++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(et,this.frictionResult)}}this.enableFrictionReduction&&it&&this.createFrictionFromAverage(it)};var Zt=new r,jt=new r;a.prototype[e.types.CONVEXPOLYHEDRON]=a.prototype.convexConvex=function(P,I,U,D,yt,rt,J,ot,S,$,it,ht){var tt=Zt;if(!(U.distanceTo(D)>P.boundingSphereRadius+I.boundingSphereRadius)&&P.findSeparatingAxis(I,U,yt,D,rt,tt,it,ht)){var Z=[],et=jt;P.clipAgainstHull(U,yt,I,D,rt,tt,-100,100,Z);for(var vt=0,wt=0;wt!==Z.length;wt++){var Y=this.createContactEquation(J,ot,P,I,S,$),xt=Y.ri,gt=Y.rj;tt.negate(Y.ni),Z[wt].normal.negate(et),et.mult(Z[wt].depth,et),Z[wt].point.vadd(et,xt),gt.copy(Z[wt].point),xt.vsub(U,xt),gt.vsub(D,gt),xt.vadd(U,xt),xt.vsub(J.position,xt),gt.vadd(D,gt),gt.vsub(ot.position,gt),this.result.push(Y),vt++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(Y,this.frictionResult)}this.enableFrictionReduction&&vt&&this.createFrictionFromAverage(vt)}};var we=new r,ye=new r,ne=new r;a.prototype[e.types.PLANE|e.types.PARTICLE]=a.prototype.planeParticle=function(P,I,U,D,yt,rt,J,ot){var S=we;S.set(0,0,1),J.quaternion.vmult(S,S);var $=ye;D.vsub(J.position,$);var it=S.dot($);if(it<=0){var ht=this.createContactEquation(ot,J,I,P);ht.ni.copy(S),ht.ni.negate(ht.ni),ht.ri.set(0,0,0);var tt=ne;S.mult(S.dot(D),tt),D.vsub(tt,tt),ht.rj.copy(tt),this.result.push(ht),this.createFrictionEquationsFromContact(ht,this.frictionResult)}};var ee=new r;a.prototype[e.types.PARTICLE|e.types.SPHERE]=a.prototype.sphereParticle=function(P,I,U,D,yt,rt,J,ot){var S=ee;S.set(0,0,1),D.vsub(U,S);var $=S.norm2();if($<=P.radius*P.radius){var it=this.createContactEquation(ot,J,I,P);S.normalize(),it.rj.copy(S),it.rj.mult(P.radius,it.rj),it.ni.copy(S),it.ni.negate(it.ni),it.ri.set(0,0,0),this.result.push(it),this.createFrictionEquationsFromContact(it,this.frictionResult)}};var _t=new o,ae=new r;new r;var oe=new r,Ht=new r,xe=new r;a.prototype[e.types.PARTICLE|e.types.CONVEXPOLYHEDRON]=a.prototype.convexParticle=function(P,I,U,D,yt,rt,J,ot){var S=-1,$=oe,it=xe,ht=null,tt=ae;if(tt.copy(D),tt.vsub(U,tt),yt.conjugate(_t),_t.vmult(tt,tt),P.pointIsInside(tt)){P.worldVerticesNeedsUpdate&&P.computeWorldVertices(U,yt),P.worldFaceNormalsNeedsUpdate&&P.computeWorldFaceNormals(yt);for(var Z=0,et=P.faces.length;Z!==et;Z++){var vt=[P.worldVertices[P.faces[Z][0]]],wt=P.worldFaceNormals[Z];D.vsub(vt[0],Ht);var Y=-wt.dot(Ht);(ht===null||Math.abs(Y)<Math.abs(ht))&&(ht=Y,S=Z,$.copy(wt))}if(S!==-1){var xt=this.createContactEquation(ot,J,I,P);$.mult(ht,it),it.vadd(D,it),it.vsub(U,it),xt.rj.copy(it),$.negate(xt.ni),xt.ri.set(0,0,0);var gt=xt.ri,Wt=xt.rj;gt.vadd(D,gt),gt.vsub(ot.position,gt),Wt.vadd(U,Wt),Wt.vsub(J.position,Wt),this.result.push(xt),this.createFrictionEquationsFromContact(xt,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},a.prototype[e.types.BOX|e.types.HEIGHTFIELD]=a.prototype.boxHeightfield=function(P,I,U,D,yt,rt,J,ot){P.convexPolyhedronRepresentation.material=P.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,this.convexHeightfield(P.convexPolyhedronRepresentation,I,U,D,yt,rt,J,ot)};var ge=new r,Be=new r,Ce=[0];a.prototype[e.types.CONVEXPOLYHEDRON|e.types.HEIGHTFIELD]=a.prototype.convexHeightfield=function(P,I,U,D,yt,rt,J,ot){var S=I.data,$=I.elementSize,it=P.boundingSphereRadius,ht=Be,tt=Ce,Z=ge;l.pointToLocalFrame(D,rt,U,Z);var et=Math.floor((Z.x-it)/$)-1,vt=Math.ceil((Z.x+it)/$)+1,wt=Math.floor((Z.y-it)/$)-1,Y=Math.ceil((Z.y+it)/$)+1;if(!(vt<0||Y<0||et>S.length||wt>S[0].length)){et<0&&(et=0),vt<0&&(vt=0),wt<0&&(wt=0),Y<0&&(Y=0),et>=S.length&&(et=S.length-1),vt>=S.length&&(vt=S.length-1),Y>=S[0].length&&(Y=S[0].length-1),wt>=S[0].length&&(wt=S[0].length-1);var xt=[];I.getRectMinMax(et,wt,vt,Y,xt);var gt=xt[0],Wt=xt[1];if(!(Z.z-it>Wt||Z.z+it<gt))for(var Bt=et;Bt<vt;Bt++)for(var Ct=wt;Ct<Y;Ct++)I.getConvexTrianglePillar(Bt,Ct,!1),l.pointToWorldFrame(D,rt,I.pillarOffset,ht),U.distanceTo(ht)<I.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.convexConvex(P,I.pillarConvex,U,ht,yt,rt,J,ot,null,null,tt,null),I.getConvexTrianglePillar(Bt,Ct,!0),l.pointToWorldFrame(D,rt,I.pillarOffset,ht),U.distanceTo(ht)<I.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.convexConvex(P,I.pillarConvex,U,ht,yt,rt,J,ot,null,null,tt,null)}};var Se=new r,qt=new r;a.prototype[e.types.SPHERE|e.types.HEIGHTFIELD]=a.prototype.sphereHeightfield=function(P,I,U,D,yt,rt,J,ot){var S=I.data,$=P.radius,it=I.elementSize,ht=qt,tt=Se;l.pointToLocalFrame(D,rt,U,tt);var Z=Math.floor((tt.x-$)/it)-1,et=Math.ceil((tt.x+$)/it)+1,vt=Math.floor((tt.y-$)/it)-1,wt=Math.ceil((tt.y+$)/it)+1;if(!(et<0||wt<0||Z>S.length||wt>S[0].length)){Z<0&&(Z=0),et<0&&(et=0),vt<0&&(vt=0),wt<0&&(wt=0),Z>=S.length&&(Z=S.length-1),et>=S.length&&(et=S.length-1),wt>=S[0].length&&(wt=S[0].length-1),vt>=S[0].length&&(vt=S[0].length-1);var Y=[];I.getRectMinMax(Z,vt,et,wt,Y);var xt=Y[0],gt=Y[1];if(!(tt.z-$>gt||tt.z+$<xt))for(var Wt=this.result,Bt=Z;Bt<et;Bt++)for(var Ct=vt;Ct<wt;Ct++){var dt=Wt.length;I.getConvexTrianglePillar(Bt,Ct,!1),l.pointToWorldFrame(D,rt,I.pillarOffset,ht),U.distanceTo(ht)<I.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.sphereConvex(P,I.pillarConvex,U,ht,yt,rt,J,ot),I.getConvexTrianglePillar(Bt,Ct,!0),l.pointToWorldFrame(D,rt,I.pillarOffset,ht),U.distanceTo(ht)<I.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.sphereConvex(P,I.pillarConvex,U,ht,yt,rt,J,ot);var Kt=Wt.length-dt;if(Kt>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(v,N,at){N.exports=f;var p=v("../shapes/Shape"),e=v("../math/Vec3"),s=v("../math/Quaternion"),r=v("../solver/GSSolver");v("../utils/Vec3Pool"),v("../equations/ContactEquation"),v("../equations/FrictionEquation");var l=v("./Narrowphase"),o=v("../utils/EventTarget"),t=v("../collision/ArrayCollisionMatrix"),i=v("../material/Material"),n=v("../material/ContactMaterial"),a=v("../objects/Body"),c=v("../utils/TupleDictionary"),h=v("../collision/RaycastResult"),u=v("../collision/AABB"),d=v("../collision/Ray"),x=v("../collision/NaiveBroadphase");function f(){o.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new e,this.broadphase=new x,this.bodies=[],this.solver=new r,this.constraints=[],this.narrowphase=new l(this),this.collisionMatrix=new t,this.collisionMatrixPrevious=new t,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new c,this.defaultMaterial=new i("default"),this.defaultContactMaterial=new n(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}f.prototype=new o,new u;var b=new d;if(f.prototype.getContactMaterial=function(A,_){return this.contactMaterialTable.get(A.id,_.id)},f.prototype.numObjects=function(){return this.bodies.length},f.prototype.collisionMatrixTick=function(){var A=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=A,this.collisionMatrix.reset()},f.prototype.add=f.prototype.addBody=function(A){this.bodies.indexOf(A)===-1&&(A.index=this.bodies.length,this.bodies.push(A),A.world=this,A.initPosition.copy(A.position),A.initVelocity.copy(A.velocity),A.timeLastSleepy=this.time,A instanceof a&&(A.initAngularVelocity.copy(A.angularVelocity),A.initQuaternion.copy(A.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=A,this.dispatchEvent(this.addBodyEvent))},f.prototype.addConstraint=function(A){this.constraints.push(A)},f.prototype.removeConstraint=function(A){var _=this.constraints.indexOf(A);_!==-1&&this.constraints.splice(_,1)},f.prototype.rayTest=function(A,_,q){q instanceof h?this.raycastClosest(A,_,{skipBackfaces:!0},q):this.raycastAll(A,_,{skipBackfaces:!0},q)},f.prototype.raycastAll=function(A,_,q,g){return q.mode=d.ALL,q.from=A,q.to=_,q.callback=g,b.intersectWorld(this,q)},f.prototype.raycastAny=function(A,_,q,g){return q.mode=d.ANY,q.from=A,q.to=_,q.result=g,b.intersectWorld(this,q)},f.prototype.raycastClosest=function(A,_,q,g){return q.mode=d.CLOSEST,q.from=A,q.to=_,q.result=g,b.intersectWorld(this,q)},f.prototype.remove=function(A){A.world=null;var _=this.bodies.length-1,q=this.bodies,g=q.indexOf(A);if(g!==-1){q.splice(g,1);for(var R=0;R!==q.length;R++)q[R].index=R;this.collisionMatrix.setNumObjects(_),this.removeBodyEvent.body=A,this.dispatchEvent(this.removeBodyEvent)}},f.prototype.removeBody=f.prototype.remove,f.prototype.addMaterial=function(A){this.materials.push(A)},f.prototype.addContactMaterial=function(A){this.contactmaterials.push(A),this.contactMaterialTable.set(A.materials[0].id,A.materials[1].id,A)},typeof performance>"u"&&(performance={}),!performance.now){var H=Date.now();performance.timing&&performance.timing.navigationStart&&(H=performance.timing.navigationStart),performance.now=function(){return Date.now()-H}}var st=new e;f.prototype.step=function(A,_,q){if(q=q||10,_=_||0,_===0)this.internalStep(A),this.time+=A;else{var g=Math.floor((this.time+_)/A)-Math.floor(this.time/A);g=Math.min(g,q);for(var R=performance.now(),w=0;w!==g&&(this.internalStep(A),!(performance.now()-R>A*1e3));w++);this.time+=_;for(var m=this.time%A,y=m/A,C=st,G=this.bodies,W=0;W!==G.length;W++){var E=G[W];E.type!==a.STATIC&&E.sleepState!==a.SLEEPING?(E.position.vsub(E.previousPosition,C),C.scale(y,C),E.position.vadd(C,E.interpolatedPosition)):(E.interpolatedPosition.copy(E.position),E.interpolatedQuaternion.copy(E.quaternion))}}};var V={type:"postStep"},k={type:"preStep"},M={type:"collide",body:null,contact:null},B=[],F=[],T=[],K=[];new e,new e,new e,new e,new e,new e,new e,new e,new e,new s;var j=new s,pt=new s,z=new e;f.prototype.internalStep=function(A){this.dt=A;var _=this.contacts,q=T,g=K,R=this.numObjects(),w=this.bodies,m=this.solver,y=this.gravity,C=this.doProfiling,G=this.profile,W=a.DYNAMIC,E,L=this.constraints,X=F;y.norm();var ut=y.x,lt=y.y,nt=y.z,O=0;for(C&&(E=performance.now()),O=0;O!==R;O++){var Q=w[O];if(Q.type&W){var bt=Q.force,ft=Q.mass;bt.x+=ft*ut,bt.y+=ft*lt,bt.z+=ft*nt}}for(var O=0,zt=this.subsystems.length;O!==zt;O++)this.subsystems[O].update();C&&(E=performance.now()),q.length=0,g.length=0,this.broadphase.collisionPairs(this,q,g),C&&(G.broadphase=performance.now()-E);var Zt=L.length;for(O=0;O!==Zt;O++){var ct=L[O];if(!ct.collideConnected)for(var St=q.length-1;St>=0;St-=1)(ct.bodyA===q[St]&&ct.bodyB===g[St]||ct.bodyB===q[St]&&ct.bodyA===g[St])&&(q.splice(St,1),g.splice(St,1))}this.collisionMatrixTick(),C&&(E=performance.now());var Rt=B,Mt=_.length;for(O=0;O!==Mt;O++)Rt.push(_[O]);_.length=0;var Vt=this.frictionEquations.length;for(O=0;O!==Vt;O++)X.push(this.frictionEquations[O]);this.frictionEquations.length=0,this.narrowphase.getContacts(q,g,this,_,Rt,this.frictionEquations,X),C&&(G.narrowphase=performance.now()-E),C&&(E=performance.now());for(var O=0;O<this.frictionEquations.length;O++)m.addEquation(this.frictionEquations[O]);for(var At=_.length,Tt=0;Tt!==At;Tt++){var ct=_[Tt],Q=ct.bi,Et=ct.bj;ct.si,ct.sj;var Lt;if(Q.material&&Et.material?Lt=this.getContactMaterial(Q.material,Et.material)||this.defaultContactMaterial:Lt=this.defaultContactMaterial,Lt.friction,Q.material&&Et.material&&(Q.material.friction>=0&&Et.material.friction>=0&&Q.material.friction*Et.material.friction,Q.material.restitution>=0&&Et.material.restitution>=0&&(ct.restitution=Q.material.restitution*Et.material.restitution)),m.addEquation(ct),Q.allowSleep&&Q.type===a.DYNAMIC&&Q.sleepState===a.SLEEPING&&Et.sleepState===a.AWAKE&&Et.type!==a.STATIC){var Ut=Et.velocity.norm2()+Et.angularVelocity.norm2(),le=Math.pow(Et.sleepSpeedLimit,2);Ut>=le*2&&(Q._wakeUpAfterNarrowphase=!0)}if(Et.allowSleep&&Et.type===a.DYNAMIC&&Et.sleepState===a.SLEEPING&&Q.sleepState===a.AWAKE&&Q.type!==a.STATIC){var fe=Q.velocity.norm2()+Q.angularVelocity.norm2(),he=Math.pow(Q.sleepSpeedLimit,2);fe>=he*2&&(Et._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(Q,Et,!0),this.collisionMatrixPrevious.get(Q,Et)||(M.body=Et,M.contact=ct,Q.dispatchEvent(M),M.body=Q,Et.dispatchEvent(M))}for(C&&(G.makeContactConstraints=performance.now()-E,E=performance.now()),O=0;O!==R;O++){var Q=w[O];Q._wakeUpAfterNarrowphase&&(Q.wakeUp(),Q._wakeUpAfterNarrowphase=!1)}var Zt=L.length;for(O=0;O!==Zt;O++){var ct=L[O];ct.update();for(var St=0,jt=ct.equations.length;St!==jt;St++){var we=ct.equations[St];m.addEquation(we)}}m.solve(A,this),C&&(G.solve=performance.now()-E),m.removeAllEquations();var ye=Math.pow;for(O=0;O!==R;O++){var Q=w[O];if(Q.type&W){var ne=ye(1-Q.linearDamping,A),ee=Q.velocity;ee.mult(ne,ee);var _t=Q.angularVelocity;if(_t){var ae=ye(1-Q.angularDamping,A);_t.mult(ae,_t)}}}for(this.dispatchEvent(k),O=0;O!==R;O++){var Q=w[O];Q.preStep&&Q.preStep.call(Q)}C&&(E=performance.now());var oe=j,Ht=pt,xe=this.stepnumber,ge=a.DYNAMIC|a.KINEMATIC,Be=xe%(this.quatNormalizeSkip+1)===0,Ce=this.quatNormalizeFast,Se=A*.5;for(p.types.PLANE,p.types.CONVEXPOLYHEDRON,O=0;O!==R;O++){var qt=w[O],P=qt.force,I=qt.torque;if(qt.type&ge&&qt.sleepState!==a.SLEEPING){var U=qt.velocity,D=qt.angularVelocity,yt=qt.position,rt=qt.quaternion,J=qt.invMass,ot=qt.invInertiaWorld;U.x+=P.x*J*A,U.y+=P.y*J*A,U.z+=P.z*J*A,qt.angularVelocity&&(ot.vmult(I,z),z.mult(A,z),z.vadd(D,D)),yt.x+=U.x*A,yt.y+=U.y*A,yt.z+=U.z*A,qt.angularVelocity&&(oe.set(D.x,D.y,D.z,0),oe.mult(rt,Ht),rt.x+=Se*Ht.x,rt.y+=Se*Ht.y,rt.z+=Se*Ht.z,rt.w+=Se*Ht.w,Be&&(Ce?rt.normalizeFast():rt.normalize())),qt.aabb&&(qt.aabbNeedsUpdate=!0),qt.updateInertiaWorld&&qt.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,C&&(G.integrate=performance.now()-E),this.time+=A,this.stepnumber+=1,this.dispatchEvent(V),O=0;O!==R;O++){var Q=w[O],S=Q.postStep;S&&S.call(Q)}if(this.allowSleep)for(O=0;O!==R;O++)w[O].sleepTick(this.time)},f.prototype.clearForces=function(){for(var A=this.bodies,_=A.length,q=0;q!==_;q++){var g=A[q];g.force,g.torque,g.force.set(0,0,0),g.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})})(ho);const te=Fe,We=new lo,Re={};Re.createSphere=()=>{Xe(Math.random()*.5,{x:(Math.random()-.5)*3,y:Math.random()*3,z:(Math.random()-.5)*3})};Re.createBox=()=>{wo(Math.random(),Math.random(),Math.random(),{x:(Math.random()-.5)*3,y:Math.random()*3,z:(Math.random()-.5)*3})};Re.reset=()=>{for(const It of Ve)ie.remove(It.body),me.remove(It.mesh),It.body.removeEventListener("collide",Ge)};We.add(Re,"createSphere");We.add(Re,"createBox");We.add(Re,"reset");const ke=document.querySelector("canvas.webgl"),me=new Ze,Te=new Audio("/sounds/hit.mp3"),Ge=It=>{It.contact.getImpactVelocityAlongNormal()>1.5&&(Te.volume=Math.random(),Te.currentTime=0,Te.play())};new je;const co=new Ke,Le=co.load(["/textures/environmentMaps/0/px.jpg","/textures/environmentMaps/0/nx.jpg","/textures/environmentMaps/0/py.jpg","/textures/environmentMaps/0/ny.jpg","/textures/environmentMaps/0/pz.jpg","/textures/environmentMaps/0/nz.jpg"]),ie=new te.World;ie.broadphase=new te.SAPBroadphase(ie);ie.allowSleep=!0;ie.gravity.set(0,-9.82,0);const uo=new te.Plane,He=new te.Body({mass:0,shape:uo});He.quaternion.setFromAxisAngle(new te.Vec3(-1,0,0),Math.PI/2);ie.addBody(He);const Pe=new te.Material("default"),Ue=new te.ContactMaterial(Pe,Pe,{friction:.1,restitution:.7});ie.addContactMaterial(Ue);ie.defaultContactMaterial=Ue;const qe=new Ne(new Je(10,10),new Ie({color:"#777777",metalness:.3,roughness:.4,envMap:Le,envMapIntensity:.5}));qe.receiveShadow=!0;qe.rotation.x=-(Math.PI/2);me.add(qe);const po=new $e(16777215,.7);me.add(po);const de=new to(16777215,.2);de.castShadow=!0;de.shadow.mapSize.set(1024,1024);de.shadow.camera.far=15;de.shadow.camera.left=-7;de.shadow.camera.top=7;de.shadow.camera.right=7;de.shadow.camera.bottom=-7;de.position.set(5,5,5);me.add(de);const se={width:window.innerWidth,height:window.innerHeight};window.addEventListener("resize",()=>{se.width=window.innerWidth,se.height=window.innerHeight,Me.aspect=se.width/se.height,Me.updateProjectionMatrix(),Ee.setSize(se.width,se.height),Ee.setPixelRatio(Math.min(window.devicePixelRatio,2))});const Me=new eo(75,se.width/se.height,.1,100);Me.position.set(-3,3,3);me.add(Me);const De=new so(Me,ke);De.enableDamping=!0;const Ee=new oo({canvas:ke});Ee.shadowMap.enabled=!0;Ee.shadowMap.type=io;Ee.setSize(se.width,se.height);Ee.setPixelRatio(Math.min(window.devicePixelRatio,2));const Ve=[],vo=new ro(1,20,20),fo=new Ie({metalness:.3,roughness:.4,envMap:Le}),Xe=(It,re)=>{const v=new Ne(vo,fo);v.scale.set(It,It,It),v.castShadow=!0,v.position.copy(re),me.add(v);const N=new te.Sphere(It),at=new te.Body({shape:N,mass:1,position:re,material:Pe});at.position.copy(re),ie.addBody(at),Ve.push({mesh:v,body:at})};Xe(.5,{x:0,y:3,z:0});const yo=new no(1,1,1),mo=new Ie({metalness:.3,roughness:.4,envMap:Le}),wo=(It,re,v,N)=>{const at=new Ne(yo,mo);at.scale.set(It,re,v),at.castShadow=!0,at.position.copy(N),me.add(at);const p=new te.Box(new te.Vec3(It/2,re/2,v/2)),e=new te.Body({shape:p,mass:1,material:Pe});e.addEventListener("collide",Ge),e.position.copy(N),ie.addBody(e),Ve.push({mesh:at,body:e})},xo=new ao;let Oe=0;const Ye=()=>{const It=xo.getElapsedTime(),re=It-Oe;Oe=It,ie.step(1/60,re,3);for(const v of Ve)v.mesh.position.copy(v.body.position),v.mesh.quaternion.copy(v.body.quaternion);De.update(),Ee.render(me,Me),window.requestAnimationFrame(Ye)};Ye();
